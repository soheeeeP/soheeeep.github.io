{
    "componentChunkName": "component---src-templates-blog-template-js",
    "path": "/django-migration-management/",
    "result": {"data":{"cur":{"id":"6fc79bbb-d121-5bea-9b0c-035b9e3b3545","html":"<p>기능을 추가하며 모델을 변경해야 할 일이 새겼다.\n테이블을 수정하고 migration을 적용하면서 dependency 오류부터 relationExists 오류까지 아주 난항을 겪었다.</p>\n<p>사실 토이프로젝트에서는 migration이 꼬이면 그냥 전부 밀어버리고 다시 적용하면 그만이었다.\n하지만 실제로 배포되고 데이터가 담겨 있는 DB의 테이블을 수정하는 경우에는 이런 1차원적인 방식으로 접근할 수는 없었다.</p>\n<p>다소 긴 삽질의 과정을 경험하며, 내가 migration에 대하여 정확히 이해를 하지 못하고 있음을 깨달았다.</p>\n<p> </p>\n<h2 id=\"-migration이란\" style=\"position:relative;\"><a href=\"#-migration%EC%9D%B4%EB%9E%80\" aria-label=\" migration이란 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>💡 Migration이란?</h2>\n<p>일종의 database version control log라고 이해하면 될 것 같다.\n<code class=\"language-text\">python manage.py makemigrations</code> 명령어를 수행하면 각 app의 모델에 대한 변경사항을 기록한 python script가 자동으로 생성되고</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">$ python manage.py makemigrations <span class=\"token punctuation\">[</span>app_name<span class=\"token punctuation\">]</span>\nMigrations <span class=\"token keyword\">for</span> <span class=\"token string\">'users'</span><span class=\"token builtin class-name\">:</span>\n  apps/users/migrations/0002_user_auth_id_user_social_type.py\n    - Add field auth_id to <span class=\"token function\">users</span>\n    - Add field social_type to <span class=\"token function\">users</span></code></pre></div>\n<p><code class=\"language-text\">python manage.py migrate</code> 명령어를 수행하면 db에 변경사항을 반영할 수 있다.\n이 migration script는 <code class=\"language-text\">000X_changelog_contents_whatever.py</code> 형식으로 네이밍되며,\n모델 간의 관계(생성 순서, 참조 방향 등)를 고려하여 순차적으로 dependency가 존재한다.</p>\n<p>예를 들어, <code class=\"language-text\">BookObject</code> 테이블에서 <code class=\"language-text\">User</code> 테이블을 FK로 참조하고 있는 경우라면\n반드시 <code class=\"language-text\">User</code> 테이블의 생성이 선행되어야만 <code class=\"language-text\">BookObject</code> 테이블을 참조할 수 있다.</p>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\"><span class=\"token keyword\">class</span> <span class=\"token class-name\">User</span><span class=\"token punctuation\">(</span>AbstractUser<span class=\"token punctuation\">,</span> TimeStampModel<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n    username <span class=\"token operator\">=</span> <span class=\"token boolean\">None</span>\n    email <span class=\"token operator\">=</span> models<span class=\"token punctuation\">.</span>EmailField<span class=\"token punctuation\">(</span>\n        max_length<span class=\"token operator\">=</span><span class=\"token number\">255</span><span class=\"token punctuation\">,</span>\n        verbose_name<span class=\"token operator\">=</span><span class=\"token string\">'이메일'</span><span class=\"token punctuation\">,</span>\n        validators<span class=\"token operator\">=</span><span class=\"token punctuation\">[</span>SpecificEmailDomainValidator<span class=\"token punctuation\">(</span>allowlist<span class=\"token operator\">=</span>domain_allowlist<span class=\"token punctuation\">)</span><span class=\"token punctuation\">]</span>\n    <span class=\"token punctuation\">)</span>\n    \n<span class=\"token keyword\">class</span> <span class=\"token class-name\">BookObject</span><span class=\"token punctuation\">(</span>TimeStampModel<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n    user <span class=\"token operator\">=</span> models<span class=\"token punctuation\">.</span>ForeignKey<span class=\"token punctuation\">(</span>\n        User<span class=\"token punctuation\">,</span>\n        on_delete<span class=\"token operator\">=</span>models<span class=\"token punctuation\">.</span>CASCADE<span class=\"token punctuation\">,</span>\n        related_name<span class=\"token operator\">=</span><span class=\"token string\">'note'</span><span class=\"token punctuation\">,</span>\n        verbose_name<span class=\"token operator\">=</span><span class=\"token string\">'작성자'</span>\n    <span class=\"token punctuation\">)</span></code></pre></div>\n<p>따라서 <code class=\"language-text\">BookObject</code> app의 migration에는 다음과 같은 dependency(<code class=\"language-text\">users.migrations.0001_initial.py</code> 을 적용한 후에 해당 migration을 적용할 수 있음)가 명시되어 있다.</p>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\"><span class=\"token keyword\">class</span> <span class=\"token class-name\">Migration</span><span class=\"token punctuation\">(</span>migrations<span class=\"token punctuation\">.</span>Migration<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n    initial <span class=\"token operator\">=</span> <span class=\"token boolean\">True</span>\n    dependencies <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span>\n        <span class=\"token punctuation\">(</span><span class=\"token string\">'users'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'0001_initial'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">]</span></code></pre></div>\n<p> </p>\n<h2 id=\"--적용된-migration-확인하기\" style=\"position:relative;\"><a href=\"#--%EC%A0%81%EC%9A%A9%EB%90%9C-migration-%ED%99%95%EC%9D%B8%ED%95%98%EA%B8%B0\" aria-label=\"  적용된 migration 확인하기 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>🔑  적용된 migration 확인하기</h2>\n<p>migration 적용 내역은 <code class=\"language-text\">django_migrations</code> 테이블에 저장되는데\n이 때 데이터베이스에 migration 내용은 저장되지 않는다. 적용 순서, script명, 시간 정도의 데이터만 확인할 수 있다.</p>\n<p><img src=\"./%5Bmigration_001.png%5D\" alt=\"migration_001.png\"></p>\n<p>따라서 이미 적용된 migration script를 수정한 뒤 다시 migrate를 수행한다고 해도 <code class=\"language-text\">django_migration</code> 테이블에 변경 내용은 저장되지 않는다.\n데이터베이스에 수정 내용이 반영되지 않고 충돌이 일어날 수도 있다.</p>\n<p><code class=\"language-text\">python manage.py showmigrations</code> 를 통해서도 한눈에 migration 적용상태를 확인할 수 있다.</p>\n<p><img src=\"./%5Bmigration_002.png%5D\" alt=\"migration_002.png\"></p>\n<p> </p>\n<h2 id=\"️-이미-적용된-migration을-revert하고-싶은-경우\" style=\"position:relative;\"><a href=\"#%EF%B8%8F-%EC%9D%B4%EB%AF%B8-%EC%A0%81%EC%9A%A9%EB%90%9C-migration%EC%9D%84-revert%ED%95%98%EA%B3%A0-%EC%8B%B6%EC%9D%80-%EA%B2%BD%EC%9A%B0\" aria-label=\"️ 이미 적용된 migration을 revert하고 싶은 경우 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>🤷🏻‍♂️ 이미 적용된 migration을 Revert하고 싶은 경우?</h2>\n<p>아래와 같이 Revert하고자 하는 app의 이름과 migration 번호를 명시하면 된다.</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">$ python manage.py migrate <span class=\"token punctuation\">[</span>app_name<span class=\"token punctuation\">]</span> <span class=\"token punctuation\">[</span>number<span class=\"token punctuation\">]</span>\n</code></pre></div>\n<p>예를 들어 0004까지 migration이 적용되어 있는 User app이 있다고 하자.\n<code class=\"language-text\">python manage.py migrate users 0002</code> 라는 명령을 수행하면, 0003 이후의 migration은 unapply되고 0002 migration 기준으로 데이터베이스가 동작한다</p>\n<p>이 때, 주의하여야 할 점은 되돌리고자 시점 이후에 대한 migration script를 절대 삭제해서는 안된다는 것이다!\n데이터베이스는 사용자가 입력한 명령을 <b>존재하지도 않는 migration을 revert하려는 것</b>으로 이해할 것이다.\n삭제된 migration을 복구할 수 없는 경우라면 직접 데이터베이스의 테이블을 수정해야 한다.</p>\n<p> </p>\n<h2 id=\"️-이미-적용된-migration-내용을-수정하고-싶은-경우\" style=\"position:relative;\"><a href=\"#%EF%B8%8F-%EC%9D%B4%EB%AF%B8-%EC%A0%81%EC%9A%A9%EB%90%9C-migration-%EB%82%B4%EC%9A%A9%EC%9D%84-%EC%88%98%EC%A0%95%ED%95%98%EA%B3%A0-%EC%8B%B6%EC%9D%80-%EA%B2%BD%EC%9A%B0\" aria-label=\"️ 이미 적용된 migration 내용을 수정하고 싶은 경우 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>🤷🏼‍♀️ 이미 적용된 migration 내용을 수정하고 싶은 경우?</h2>\n<p>n번째 migration 적용 내역을 수정하고 싶다면 어떻게 하면 될까?\nn+1번째의 새로운 migration script를 생성하면 된다. 위에 언급한 것처럼\n이미 적용된 migration을 수정하는 것은 데이터베이스에 충돌을 불러올 수도 있고, 이후에 적용할 migration에서 충돌이 발생할 수도 있다.</p>\n<p>그래도 n번째로 적용된 migration을 수정하는 방향으로 개발을 하고 싶다면,\n이전 n-1번째 version으로 revert를 수행한뒤에 새롭게 n번째 migration script를 생성하고 적용하면 된다.</p>\n<p> </p>\n<h2 id=\"-migration을-squash하여-log를-관리하고-싶은-경우\" style=\"position:relative;\"><a href=\"#-migration%EC%9D%84-squash%ED%95%98%EC%97%AC-log%EB%A5%BC-%EA%B4%80%EB%A6%AC%ED%95%98%EA%B3%A0-%EC%8B%B6%EC%9D%80-%EA%B2%BD%EC%9A%B0\" aria-label=\" migration을 squash하여 log를 관리하고 싶은 경우 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>🤷🏻 migration을 Squash하여 log를 관리하고 싶은 경우?</h2>\n<p><code class=\"language-text\">python manage.py squashmigrations</code>를 사용하여\n존재하는 많은 수의 migration을 한 개(또는 그 이상)의 migration으로 합쳐서 관리할 수 있다.</p>\n<p>예를 들어 <code class=\"language-text\">CreateModel</code>과 <code class=\"language-text\">DeleteModel</code> action을 합칠 수 있고, <code class=\"language-text\">AddField</code> action을 <code class=\"language-text\">CreateModel</code> 내부로 roll 시킬 수 있을 것이다.</p>\n<p>squash된 migration과 이전 버전의 migration log는 동시에 존재할 수 있다.\nDjango는 migration이 적용되는 시점을 자동으로 파악하여 새로운 version에서는 squash된 migration을 적용하고 이전 버전의 migration을 skip한다.</p>\n<p><code class=\"language-text\">--squashed-name</code> 옵션을 사용하여 squash할 migration script의 이름을 지정할 수도 있다.</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">$ python manage.py squashmigrations <span class=\"token punctuation\">[</span>app_name<span class=\"token punctuation\">]</span> <span class=\"token punctuation\">[</span>number<span class=\"token punctuation\">]</span> <span class=\"token parameter variable\">--squaushed_name</span> <span class=\"token punctuation\">[</span>SQUASHED_NAME<span class=\"token punctuation\">]</span>\nWill squash the following migrations:\n - 0001_initial\n - 0002_some_change\n - 0003_another_change\n - 0004_undo_something\nDo you wish to proceed? <span class=\"token punctuation\">[</span>y/N<span class=\"token punctuation\">]</span> y\nOptimizing<span class=\"token punctuation\">..</span>.\n  Optimized from <span class=\"token number\">12</span> operations to <span class=\"token number\">7</span> operations.\nCreated new squashed migration /home/andrew/Programs/DjangoTest/test/migrations/0001_squashed_0004_undo_somthing.py\n  You should commit this migration but leave the old ones <span class=\"token keyword\">in</span> place<span class=\"token punctuation\">;</span>\n  the new migration will be used <span class=\"token keyword\">for</span> new installs. Once you are sure\n  all instances of the codebase have applied the migrations you squashed,\n  you can delete them.</code></pre></div>\n<div class=\"table-of-contents\">\n<ul>\n<li><a href=\"#-migration%EC%9D%B4%EB%9E%80\">💡 Migration이란?</a></li>\n<li><a href=\"#--%EC%A0%81%EC%9A%A9%EB%90%9C-migration-%ED%99%95%EC%9D%B8%ED%95%98%EA%B8%B0\">🔑  적용된 migration 확인하기</a></li>\n<li><a href=\"#%EF%B8%8F-%EC%9D%B4%EB%AF%B8-%EC%A0%81%EC%9A%A9%EB%90%9C-migration%EC%9D%84-revert%ED%95%98%EA%B3%A0-%EC%8B%B6%EC%9D%80-%EA%B2%BD%EC%9A%B0\">🤷🏻‍♂️ 이미 적용된 migration을 Revert하고 싶은 경우?</a></li>\n<li><a href=\"#%EF%B8%8F-%EC%9D%B4%EB%AF%B8-%EC%A0%81%EC%9A%A9%EB%90%9C-migration-%EB%82%B4%EC%9A%A9%EC%9D%84-%EC%88%98%EC%A0%95%ED%95%98%EA%B3%A0-%EC%8B%B6%EC%9D%80-%EA%B2%BD%EC%9A%B0\">🤷🏼‍♀️ 이미 적용된 migration 내용을 수정하고 싶은 경우?</a></li>\n<li><a href=\"#-migration%EC%9D%84-squash%ED%95%98%EC%97%AC-log%EB%A5%BC-%EA%B4%80%EB%A6%AC%ED%95%98%EA%B3%A0-%EC%8B%B6%EC%9D%80-%EA%B2%BD%EC%9A%B0\">🤷🏻 migration을 Squash하여 log를 관리하고 싶은 경우?</a></li>\n</ul>\n</div>","excerpt":"기능을 추가하며 모델을 변경해야 할 일이 새겼다.\n테이블을 수정하고 migration을 적용하면서 dependency 오류부터 relationExists 오류까지 아주 난항을 겪었다. 사실 토이프로젝트에서는 migration이 꼬이면 그냥 전부 밀어버리고 다시 적용하면 그만이었다.\n하지만 실제로 배포되고 데이터가 담겨 있는 DB의 테이블을 수정하는 경우에는 이런 1차원적인 방식으로 접근할 수는 없었다. 다소 긴 삽질의 과정을 경험하며, 내가 migration에 대하여 정확히 이해를 하지 못하고 있음을 깨달았다.   💡 Migration이란? 일종의 database version control log라고 이해하면 될 것 같다.\n 명령어를 수행하면 각 app의 모델에 대한 변경사항을 기록한 python script가 자동으로 생성되고  명령어를 수행하면 db에 변경사항을 반영할 수 있다.\n이 migration script는  형식으로 네이밍되며,\n모델 간의 관계(생성 순서, 참조 방향…","frontmatter":{"date":"December 30, 2022","title":"Django에서 migration으로 테이블 관리하기","categories":"웹 프레임워크","author":"소희","emoji":"🐤"},"fields":{"slug":"/django-migration-management/"}},"next":null,"prev":null,"site":{"siteMetadata":{"siteUrl":"https://soheeeep.github.io","comments":{"utterances":{"repo":"https://github.com/soheeeeP/soheeeep.github.io"}}}}},"pageContext":{"slug":"/django-migration-management/","nextSlug":"","prevSlug":""}},
    "staticQueryHashes": ["1073350324","2938748437"]}
{"componentChunkName":"component---src-templates-blog-template-js","path":"/opensource/backend.ai/hotfix/","result":{"data":{"cur":{"id":"d73fdcd6-7a21-563b-89c3-cdc8fb4afd89","html":"<p>얼마전, 오픈소스에 하나의 PR을 머지시켰다.<br>\n다음날 레포를 확인해보니, 내가 merge시킨 기능과 관련한 hotfix가 2개나 열려있었다..</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 720px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 26.666666666666668%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAFCAYAAABFA8wzAAAACXBIWXMAAAsTAAALEwEAmpwYAAABFklEQVQY032PPU+DYBRG+f+7m7uJSxc1URcHTWzVGGM1QKF8f5bCC7y02ALHQBNHn+Tmnrs8OVfpuh5ZHXFclzCMCIKQtWX/sed5WLZNe/ghmZ1j3txyd73hfuax/LZ50RbMlwseP55IRYoyDANjqecHRHGCH4S4nk+cpIRRPLHtuORFQaF/EukGupqhazl2nBNsXESTEW9Ddu0Ope8H2v0R2TRI2VCWFXUtKQpBWVXT1FKSbXPEriWvKvZtQ7sNEF9vJH6Db+0RWccYpe8GmvqA7TiYawtV01lbFqqq/d2GYbJaGbiui2ma5EWFXL7iX5wxfwi5unR4f05PhePLMFBW9clMlIjRUjbTnoylnLjve/7L2PUL5aN03dklzWkAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"os-hotfix-001.png\"\n        title=\"os-hotfix-001.png\"\n        src=\"/static/6040a77e93f3fbd9a9d2114ca8ededc7/37523/os-hotfix-001.png\"\n        srcset=\"/static/6040a77e93f3fbd9a9d2114ca8ededc7/e9ff0/os-hotfix-001.png 180w,\n/static/6040a77e93f3fbd9a9d2114ca8ededc7/f21e7/os-hotfix-001.png 360w,\n/static/6040a77e93f3fbd9a9d2114ca8ededc7/37523/os-hotfix-001.png 720w,\n/static/6040a77e93f3fbd9a9d2114ca8ededc7/302a4/os-hotfix-001.png 1080w,\n/static/6040a77e93f3fbd9a9d2114ca8ededc7/62a6a/os-hotfix-001.png 1122w\"\n        sizes=\"(max-width: 720px) 100vw, 720px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n    </span>\n<br></p>\n<h2 id=\"768-create-vfolder-status-correctly\" style=\"position:relative;\"><a href=\"#768-create-vfolder-status-correctly\" aria-label=\"768 create vfolder status correctly permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/lablup/backend.ai/pull/768\">#768</a>. create vfolder status correctly</h2>\n<p>첫번째로 새로 추가한 컬럼(<code class=\"language-text\">vfolder.status</code>)의 default value 설정값과 관련하여 버그가 발생한 듯하다.\npython sqlalchemy에서는 다음과 같은 포맷으로 table과 column을 관리한다.</p>\n<p>테이블에 컬럼을 추가하는 작업을 진행할 때, 컬럼의 기본값을 지정해주기 위해 <code class=\"language-text\">default</code> 인자를 사용했다. 하지만 이미 존재하던 테이블에 새로운 컬럼을 추가한 것이므로, 새로운 데이터를 생성할 때 뿐만 아니라 기존에 table에 존재하던 데이터에 이 속성의 값을 어떻게 설정해주어야 할지까지 고려했어야 했다. 따라서 “없던 속성을 새로 추가한 상황”에서는 단순히 컬럼의 기본 속성값을 지정해주는 <code class=\"language-text\">default</code>가 아닌, 해당 속성을 가지고 있지 않던 데이터에도 기본값을 저장하도록 <code class=\"language-text\">server_default</code> 인자를 사용했어야 했다.</p>\n<br>\n<h2 id=\"770-vfolder-api-crashing\" style=\"position:relative;\"><a href=\"#770-vfolder-api-crashing\" aria-label=\"770 vfolder api crashing permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/lablup/backend.ai/pull/770\">#770</a>. vfolder API crashing</h2>\n<p>vfolder를 filtering하는 decorater를 모든 API handler에 추가한 것에서 충돌이 난것 같다.\n프로젝트 소스코드에 대한 이해능력이 부족해서 인지하지도 못하고 있던 문제다. 새로운 기능을 추가하는 것인 만큼 기존 오퍼레이션들의 인자 하나하나까지 다 확인하여 예외처리를 구현했어야 했다.</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 664px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 57.22222222222223%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAYAAAB/Ca1DAAAACXBIWXMAAAsTAAALEwEAmpwYAAACGklEQVQoz3WQ2Y6bQBBF+f+PSqQoE0XyeBnb2OMF22wNdLOaBrzBiWAcS3lISdW3+uGeuirj4Mw4OROEWHMuI8pKkiYu1vGTg7PFcXdYxxWH0xpPWITKRURH4tRDV5JSR5RactYhVZ1hjNnzrZnwI5nik+AS46MwswMjsWYmN7wLk5G/ZB5vMQubjXawHyEe8asdFKorMKZs+VlN+Z1+EHQ9LCa4h6zkjpG3YhnvmXgm786cj2DNOj1gJkfsq0AQIzqF6H2dJGkLjAlb3i4fjEqTgC+geETsc5tFYLGKDywTi4XcslB7FvGRZXpiLjdYlUdAgt8pPCTx34S/rnNGZ3NI2G8NWsm+cFipE5vMZqn2mMkBq/Zx7pLjJRhgXqueKb/OlPTAEWu+N2PesileJ3GReHfBZ2zxbm+Y+hvGwYqxMJmpHYvM5kPthhvvandI1vscIlSXY4guwb4FOFVI0VYUraZ4aJRO8TNFeE7wC4lXKLw8JrkWZA9NejsPc/7QX55Oox8Nxmw8Q4qIvnRZUel66Ka+8N/q/tWy0CQq5Xa9YzSXhjCK2O4tHNfleLI5HE9EUhInCY7rEYQhSZrh+QJfBIMGYUReFMP/ZDsDI00zjH5DluUDLAhCxGDwyfOcqq4ptUbrCq31MJdlOWhVVS9t25au6wY1+ud6vVHXNZfrlbppaJrmBdFPYA/ST6B+gs7n8+B7XaLr+AM79DlnrnqReAAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"os-hotfix-003.png\"\n        title=\"os-hotfix-003.png\"\n        src=\"/static/d07abe4d99380d20afb22f3fc2dbf0df/31493/os-hotfix-003.png\"\n        srcset=\"/static/d07abe4d99380d20afb22f3fc2dbf0df/e9ff0/os-hotfix-003.png 180w,\n/static/d07abe4d99380d20afb22f3fc2dbf0df/f21e7/os-hotfix-003.png 360w,\n/static/d07abe4d99380d20afb22f3fc2dbf0df/31493/os-hotfix-003.png 664w\"\n        sizes=\"(max-width: 664px) 100vw, 664px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n    </span></p>\n<br>","excerpt":"얼마전, 오픈소스에 하나의 PR을 머지시켰다. 다음날 레포를 확인해보니, 내가 merge시킨 기능과 관련한 hotfix가 2개나 열려있었다.. \n #768. create vfolder status correctly 첫번째로 새로 추가한 컬럼()의 default value 설정값과 관련하여 버그가 발생한 듯하다.\npython sqlalchemy에서는 다음과 같은 포맷으로 table과 column을 관리한다. 테이블에 컬럼을 추가하는 작업을 진행할 때, 컬럼의 기본값을 지정해주기 위해  인자를 사용했다. 하지만 이미 존재하던 테이블에 새로운 컬럼을 추가한 것이므로, 새로운 데이터를 생성할 때 뿐만 아니라 기존에 table에 존재하던 데이터에 이 속성의 값을 어떻게 설정해주어야 할지까지 고려했어야 했다. 따라서 “없던 속성을 새로 추가한 상황”에서는 단순히 컬럼의 기본 속성값을 지정해주는 가 아닌, 해당 속성을 가지고 있지 않던 데이터에도 기본값을 저장하도록  인자를 사용했어야 했다. …","frontmatter":{"date":"October 06, 2022","title":"(Backend.AI) hotfix PR 뜯어보기","categories":"오픈소스 데이터베이스","author":"소희","emoji":"👩🏻‍💻"},"fields":{"slug":"/opensource/backend.ai/hotfix/"}},"next":{"id":"94e1c6c1-c612-5182-8c1b-167e76c4d795","html":"<h2 id=\"issue-contents-614\" style=\"position:relative;\"><a href=\"#issue-contents-614\" aria-label=\"issue contents 614 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Issue Contents <a href=\"https://github.com/lablup/backend.ai/issues/614\">#614</a></h2>\n<p>존재하지 않는 이미지로 세션을 생성할 때 발생하는 ImageNotFound 에러의 메세지 typo errorf를 수정한다.</p>\n<h2 id=\"ideation--issue-solving\" style=\"position:relative;\"><a href=\"#ideation--issue-solving\" aria-label=\"ideation  issue solving permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Ideation &#x26; Issue Solving</h2>\n<ul>\n<li>ImageNotFound typo error 수정 (<a href=\"https://github.com/lablup/backend.ai/pull/615/commits/a9801d55e69c67257b4d0a7401d84557e2b9554a\">a9801d</a>)</li>\n</ul>\n<h2 id=\"주요-변경개선-사항\" style=\"position:relative;\"><a href=\"#%EC%A3%BC%EC%9A%94-%EB%B3%80%EA%B2%BD%EA%B0%9C%EC%84%A0-%EC%82%AC%ED%95%AD\" aria-label=\"주요 변경개선 사항 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>주요 변경/개선 사항</h2>\n<ul>\n<li>반영완료 <a href=\"https://github.com/lablup/backend.ai/pull/615\">#615</a></li>\n</ul>\n<br>\n<h2 id=\"\" style=\"position:relative;\"><a href=\"#\" aria-label=\" permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h2>\n<div class=\"table-of-contents\">\n<ul>\n<li><a href=\"#issue-contents-614\">Issue Contents #614</a></li>\n<li><a href=\"#ideation--issue-solving\">Ideation &#x26; Issue Solving</a></li>\n<li><a href=\"#%EC%A3%BC%EC%9A%94-%EB%B3%80%EA%B2%BD%EA%B0%9C%EC%84%A0-%EC%82%AC%ED%95%AD\">주요 변경/개선 사항</a></li>\n</ul>\n</div>","frontmatter":{"date":"October 03, 2022","title":"(Backend.AI) 614. ImageNotFound message typo error","categories":"오픈소스","author":"소희","emoji":"👩🏻‍💻"},"fields":{"slug":"/opensource/backend.ai/image-typo/"}},"prev":{"id":"16804f52-497a-59a5-92f4-51f8aa8d7bdd","html":"<p>Github Action은 <b>build, test, deployment와 같은 workflow를 자동화할 수 있는 CI/CD 플랫폼</b>으로,\ngithub repository에서 발생하는 모든 이벤트(push, pull request, merge 등)에 대하여 정해진 동작을 실행시키도록 할 수 있다.</p>\n<p>진행중인 프로젝트에서는 <code class=\"language-text\">docker-compose</code>를 이용해 서비스 컨테이너들을 관리하고 있다.\n소스코드가 수정될 때마다 수동으로 컨테이너를 삭제하고 빌드하는 방식으로 테스트 서버를 운영하다가 <code class=\"language-text\">Github Action</code>을 사용하여 CI/CD를 자동화해보기로 했다.</p>\n<br>\n<h2 id=\"cicd-프로세스-설계해보기\" style=\"position:relative;\"><a href=\"#cicd-%ED%94%84%EB%A1%9C%EC%84%B8%EC%8A%A4-%EC%84%A4%EA%B3%84%ED%95%B4%EB%B3%B4%EA%B8%B0\" aria-label=\"cicd 프로세스 설계해보기 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>CI/CD 프로세스 설계해보기</h2>\n<p>다음과 같은 프로세스들을 자동화시키려 하였다.</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 720px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 33.33333333333333%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAHCAYAAAAIy204AAAACXBIWXMAAAsTAAALEwEAmpwYAAABZklEQVQoz0WRu27cMBBF1TrepyRKosSHRL210nph2EkQpEqbMk2ANKkC5P8/4ASkg3VxwcE87gwOo26+YdxErBZS98JZryRqJjErdX+hn584pSUP+4THQ8rDLiYrG7bnzxg348Yr8/UVUdZI0xFdbh9x0xXlFky/YYcrql3Q7SUYNsOKbmeqeqCsJ3I7UeiW0g5I02O6BdstuHFDu4no+dNX6mG7J7vlFozqwWsN8gu9cVjWP5ErR1wYMuWomjHIzylvmFUtHw4ph7hgd8pC/HgUId6f8/DuTiLEvufoJRSHRL7Xz3mY8fXox68/FKoJFyS5/m+QBSal6ZC6pWoWctWSlTWptKRqZB/Le+8xkQGJkJbo5++/aDeimpGsaohzzUlUlLYPGHy+ajcy1b6ZeZWOODecRRV6PYK6X98+5cu372HYM/AMRdWQFAZp+zsfb+r5eIXPcStCdSTSkEgbrtduptAd/wAJUL4ZAyd6vgAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"cicd-001.png\"\n        title=\"cicd-001.png\"\n        src=\"/static/d4c07304f7de23c847b09043b3f9be09/37523/cicd-001.png\"\n        srcset=\"/static/d4c07304f7de23c847b09043b3f9be09/e9ff0/cicd-001.png 180w,\n/static/d4c07304f7de23c847b09043b3f9be09/f21e7/cicd-001.png 360w,\n/static/d4c07304f7de23c847b09043b3f9be09/37523/cicd-001.png 720w,\n/static/d4c07304f7de23c847b09043b3f9be09/c483d/cicd-001.png 751w\"\n        sizes=\"(max-width: 720px) 100vw, 720px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n    </span><em>github/workflow에 YAML파일 생성</em></p>\n<ol>\n<li>생성된 pull request에 대하여 <b>자동으로 build 테스트를 수행</b> → 실패시 merge 불가</li>\n<li>main branch에 pull request가 merge된 경우,\na) production 서버에 동작하던 컨테이너를 중지 / dangling image를 삭제하여 서버 여유공간 확보\nb) production 서버에 <b>새로운 container들을 빌드</b>\nc) container가 정상적으로 동작하지 않는 경우, <b>rollback</b></li>\n<li>pull request를 활용한 소스코드 <b>release, tag 생성 및 관리 자동화</b></li>\n</ol>\n<br>\n<h2 id=\"github를-활용한-cicd-환경-관리\" style=\"position:relative;\"><a href=\"#github%EB%A5%BC-%ED%99%9C%EC%9A%A9%ED%95%9C-cicd-%ED%99%98%EA%B2%BD-%EA%B4%80%EB%A6%AC\" aria-label=\"github를 활용한 cicd 환경 관리 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Github를 활용한 CI/CD 환경 관리</h2>\n<p><code class=\"language-text\">Repository > Settings > Secrets</code>를 사용하여 환경변수를 세팅한다.\nworkflow에서 env 파일을 생성하고 비밀키 값들을 넘겨주는 방식으로 관리했다.</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 720px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 70.55555555555556%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAOCAYAAAAvxDzwAAAACXBIWXMAAAsTAAALEwEAmpwYAAACLElEQVQ4y2WU2XLaQBBF9eg4rEL7LBqBYJBAYMCk7KosT/mRPCX//wE3dVvIhe2HqS7Ro9unb7cIosyirFuEicZolmA8T/F1GiPOSzTdM5a+w3Z/QaaXeBiFknucRnj4Mof+3eD87xdOf37g+Pc71E+PgIKL1IrQcCg8jxW08yhsDV155LYW0aRwyMwKuV5BdR72W4vqpYN73WPuNIIwNXDrHUzlYZdbaLfB4yRCqhx2x2f49oj90xXN/oz2cMHueEV3fsHh8oq1f0KaVtDGQ6k1JrMMAVuN8lIqz6JC6EbTGGFWwmxO0PUR1p9h/BnWX6CqBrlZQbmNEBdl3dObJdhtQKHN7oSiXGMcZhjdWp5GCmnZIC23EmPjEemNFKId80R/OtOo6D0sV42YPQyFkbTb7iLF1u0TUl1hkRnEyiEqnHQlsXCIeVQF2ieE7eGKwq5FdBjMJMykBZKb5VY2gZG/06ZUBlTJHbbu6p2Qi+DKd/JwP2VGXqZfjMyT+q0YCbMSYWJkxViY+SC+IXOyFOopE3mJF2k+L360hIJx7oSWpKba9oJMsJVhbdjaQEJ6u2yE7t4OHooRZJGa94JxZtEeryLUE2RvJAt6aGs5JL4XZK5vWb9v2dQHWWC+RK/i206SqvewFvrpIn8rNPgr3n5seZFX8LuTtE0RVuShAMX1nYf3hL2HPWGqKthVg1mkEIxniYjx+xyMH0hYgB5R/F5syA2T538B14j3/gPVb27Lq9MSqgAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"cicd-002.png\"\n        title=\"cicd-002.png\"\n        src=\"/static/f7f9e86e3dca7ad341667b65a4dadf64/37523/cicd-002.png\"\n        srcset=\"/static/f7f9e86e3dca7ad341667b65a4dadf64/e9ff0/cicd-002.png 180w,\n/static/f7f9e86e3dca7ad341667b65a4dadf64/f21e7/cicd-002.png 360w,\n/static/f7f9e86e3dca7ad341667b65a4dadf64/37523/cicd-002.png 720w,\n/static/f7f9e86e3dca7ad341667b65a4dadf64/c8e86/cicd-002.png 758w\"\n        sizes=\"(max-width: 720px) 100vw, 720px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n    </span></p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 587px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 48.33333333333333%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAKCAYAAAC0VX7mAAAACXBIWXMAAAsTAAALEwEAmpwYAAABdElEQVQoz4WS2W7CMBBFeS5LQmJnc0lCFgJhX1SWUkClaqW+VO3//8utZiICtEg8HNmeia/vzKTidCLo0kNNt9AwXWjCO6+Gi3rTvoK+I/7GT1TUIIEdh3DDHlQyhBNksP0O3HYPwovwUDdRbYgCTV4J3xbspwj7M6TjLfxsCtvPYLVSuO2cUfGQz4RQ8X2HThpBdTMIFcEJe+yULjetFmM4AXT5yGhC3RekJPXRaiWQKmaoVM2kvkpUNcFrwW2hyzgLWn6KaLBEqzPhNZ1ukT8dEXTnV4OoabIUr2ryn1vas6BhBxBeG6YbnqGzE0KXiqdN5RZle7yndtDfQEI0MHqkcKhJNG0f8XCN6eELg80Hsvke/dU78uUbOrMdkvEG2WzHudH2E9lsX+SmL0jGz9x7MlU61IXiaUbDFeLRmqdN5Z+geJgv4EX9sr8NwyndEnRmQeqFYftIJ1vMX7/ZATki4e7igPnxh53RIyRQlGddcD2wX9t3BlBmSdckAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"cicd-003.png\"\n        title=\"cicd-003.png\"\n        src=\"/static/3eca43c9227b3ee47247ddc66f09a18c/d72eb/cicd-003.png\"\n        srcset=\"/static/3eca43c9227b3ee47247ddc66f09a18c/e9ff0/cicd-003.png 180w,\n/static/3eca43c9227b3ee47247ddc66f09a18c/f21e7/cicd-003.png 360w,\n/static/3eca43c9227b3ee47247ddc66f09a18c/d72eb/cicd-003.png 587w\"\n        sizes=\"(max-width: 587px) 100vw, 587px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n    </span></p>\n<p>아래와 같이 repository에 Self-Hosted Runner를 등록하여 관리 중인 서버에서 자동으로 빌드와 배포를 수행하도록 하였다.\nrunner는 프로젝트의 EC2 instance에서 daemon으로 동작하고 있다.</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 720px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 40.55555555555556%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAICAYAAAD5nd/tAAAACXBIWXMAAAsTAAALEwEAmpwYAAABTUlEQVQoz11R2W7CQAzcR8SRkGuPJHsQYIGQCFGpUvvQH2lf+v8/MZWtbot4GNnWrscztihlD7s7oVIW661EVmqs8obreL3DH0YssxqrR+Q1lqsKuTO4fL7i+vWG6fsd/ccZojYesg1MkkDEpbLYxQluf4G2e+h+D+0iQ9kjlI0wwxn+ZUa4X2FvZxSuhyiajhV2PjJad2DCbd1CdTsmav0R2h3RuBEyTGj8BBlmSD+jVAdscoVNprDOJARZNu6AfndiAiLaFAp5ZdD6CHJQyJ4VV4piz/EPxsHQsC7wH0G7GuIM1Q+sLIF2SZYr1WGxyrBYZqi05eZaezRt4LguFKQNaEzAptQQlXYYTjPIOu2P1CWQWtofkachpJxiQnJDoFxQE12zMZ4vSI2JkPLnIen9+V+qhQ4j4nhDF+LvEQZoO7Dix+bHpseaUfznP9o9zMdxKmyvAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"cicd-004.png\"\n        title=\"cicd-004.png\"\n        src=\"/static/fcf2e12f372d71ede39c7e5f620fe06c/37523/cicd-004.png\"\n        srcset=\"/static/fcf2e12f372d71ede39c7e5f620fe06c/e9ff0/cicd-004.png 180w,\n/static/fcf2e12f372d71ede39c7e5f620fe06c/f21e7/cicd-004.png 360w,\n/static/fcf2e12f372d71ede39c7e5f620fe06c/37523/cicd-004.png 720w,\n/static/fcf2e12f372d71ede39c7e5f620fe06c/3c051/cicd-004.png 760w\"\n        sizes=\"(max-width: 720px) 100vw, 720px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n    </span></p>\n<br>\n<h2 id=\"workflow-구현하기\" style=\"position:relative;\"><a href=\"#workflow-%EA%B5%AC%ED%98%84%ED%95%98%EA%B8%B0\" aria-label=\"workflow 구현하기 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Workflow 구현하기</h2>\n<ol>\n<li>\n<p><code class=\"language-text\">build.yml</code></p>\n<ul>\n<li>생성된 pull request에 대하여 자동으로 build 테스트를 수행하는 workflow</li>\n<li>ubuntu 환경 구성 / container의 동작을 관리하는 shell script를 수행하는 step을 실행하도록 구현</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\"><span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> Build Test\n<span class=\"token key atrule\">on</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span>pull_request<span class=\"token punctuation\">]</span>  <span class=\"token comment\"># pull request event에 대하여 trigger되는 workflow</span>\n<span class=\"token key atrule\">jobs</span><span class=\"token punctuation\">:</span>\n<span class=\"token key atrule\">build</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">runs-on</span><span class=\"token punctuation\">:</span> ubuntu<span class=\"token punctuation\">-</span>latest\n    <span class=\"token key atrule\">steps</span><span class=\"token punctuation\">:</span>\n    <span class=\"token comment\"># 프로젝트 소스코드를 리눅스 환경에 checkout하고 실행하도록 명시</span>\n    <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> Checkout source code\n        <span class=\"token key atrule\">uses</span><span class=\"token punctuation\">:</span> actions/checkout@v3\n        \n    <span class=\"token comment\"># 해당 workflow를 python3.8 환경에서 실행하겠다고 명시</span>\n    <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> Setup python\n        <span class=\"token key atrule\">uses</span><span class=\"token punctuation\">:</span> actions/setup<span class=\"token punctuation\">-</span>python@v3\n        <span class=\"token key atrule\">with</span><span class=\"token punctuation\">:</span>\n        <span class=\"token key atrule\">python-version</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"3.8\"</span>\n    \n    <span class=\"token comment\"># 리눅스 환경에 docker를 세팅하는 shell script를 실행</span>\n    <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> Setup Docker\n        <span class=\"token key atrule\">run</span><span class=\"token punctuation\">:</span> sh scripts/setup<span class=\"token punctuation\">-</span>docker.sh\n\n    <span class=\"token comment\"># ${{ secrets.* }} 변수를 사용하여 Settings > Secrets > Actions에 정의한 값을 가져오고</span>\n    <span class=\"token comment\"># .env파일을 생성하여 dev환경의 환경변수를 관리</span>\n    <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> Create env file\n        <span class=\"token key atrule\">run</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">|</span><span class=\"token scalar string\">\n        touch ${{ secrets.ENV_PATH }}\n        {\n            echo SECRET_KEY=\"\\\"${{ secrets.SECRET_KEY }}\"\\\"\n            echo RUN_ENV=\"\\\"${{ secrets.RUN_ENV }}\"\\\"\n            echo DOMAIN=\"\\\"${{ secrets.DOMAIN }}\"\\\"\n            echo PROD_ALLOWED_HOSTS='${{ secrets.PROD_ALLOWED_HOSTS }}'\n            echo CORS_ORIGIN_WHITELIST='${{ secrets.CORS_ORIGIN_WHITELIST }}'\n            ...\n        } >> ${{ secrets.ENV_PATH }}</span>\n    \n    <span class=\"token comment\"># containter를 빌드하고 배포하는 shell script를 수행</span>\n    <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> Build Docker containers\n        <span class=\"token key atrule\">run</span><span class=\"token punctuation\">:</span> sudo kill `sudo lsof <span class=\"token punctuation\">-</span>t <span class=\"token punctuation\">-</span>i<span class=\"token punctuation\">:</span>8084` <span class=\"token important\">&amp;&amp;</span> sh scripts/build<span class=\"token punctuation\">-</span>docker<span class=\"token punctuation\">-</span>compose.sh\n\n    <span class=\"token comment\"># container의 동작 상태를 확인한 뒤 job을 종료</span>\n    <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> Check container running state\n        <span class=\"token key atrule\">run</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">|</span><span class=\"token scalar string\">\n        if [ $(docker ps --format \"{{.Names}} {{.Status}}\" | grep \"Up\" | wc -l) -ne 3 ]\n        then\n            echo \"Build error while running docker-compose\"\n            exit 1\n        else\n            echo \"Deploy Complete\"\n        fi</span></code></pre></div>\n</li>\n<li>\n<p><code class=\"language-text\">schedule-deploy.yml</code></p>\n<ul>\n<li>production 서버에 동작하던 컨테이너를 중지 / dangling image를 삭제하여 서버 공간을 확보하는 동작을 별도의 shell script로 작성하여 workflow의 step에서 실행</li>\n<li>production 서버에 새로운 container들을 빌드 및 배포한뒤 동작 상태를 확인</li>\n<li>정상적으로 동작하지 않는 경우, 이전 버전의 release로 rollback</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\"><span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> Schedule Deployment\n<span class=\"token key atrule\">on</span><span class=\"token punctuation\">:</span>     <span class=\"token comment\"># main branch를 target으로 하는 pull request가 closed되었을 경우에만 동작하는 workflow</span>\n<span class=\"token key atrule\">pull_request</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">branches</span><span class=\"token punctuation\">:</span>\n    <span class=\"token punctuation\">-</span> main\n    <span class=\"token key atrule\">types</span><span class=\"token punctuation\">:</span>\n    <span class=\"token punctuation\">-</span> closed\n<span class=\"token key atrule\">jobs</span><span class=\"token punctuation\">:</span>\n<span class=\"token key atrule\">checkout</span><span class=\"token punctuation\">:</span>\n    <span class=\"token comment\"># 프로젝트를 build할 machine(runner)를 명시</span>\n    <span class=\"token key atrule\">runs-on</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span> self<span class=\"token punctuation\">-</span>hosted<span class=\"token punctuation\">,</span> label<span class=\"token punctuation\">-</span>go <span class=\"token punctuation\">]</span>\n    <span class=\"token comment\"># pull request가 merge된 경우에만 checkout job을 수행</span>\n    <span class=\"token key atrule\">if</span><span class=\"token punctuation\">:</span> $<span class=\"token punctuation\">{</span><span class=\"token punctuation\">{</span> github.event.pull_request.merged == true <span class=\"token punctuation\">}</span><span class=\"token punctuation\">}</span>\n    <span class=\"token key atrule\">steps</span><span class=\"token punctuation\">:</span>\n    <span class=\"token comment\"># runner가 workflow를 수행할 수 있도록 workspace에 permission 부여</span>\n    <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> Set Permissions\n        <span class=\"token key atrule\">run</span><span class=\"token punctuation\">:</span> sudo chown <span class=\"token punctuation\">-</span>R $USER<span class=\"token punctuation\">:</span>$USER $<span class=\"token punctuation\">{</span><span class=\"token punctuation\">{</span> github.workspace <span class=\"token punctuation\">}</span><span class=\"token punctuation\">}</span>\n\n    <span class=\"token comment\"># 프로젝트 소스코드를 리눅스 환경에 checkout하고 실행하도록 명시</span>\n    <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> Checkout source code\n        <span class=\"token key atrule\">uses</span><span class=\"token punctuation\">:</span> actions/checkout@v3\n        \n    <span class=\"token comment\"># 해당 workflow를 python3.8 환경에서 실행하겠다고 명시</span>\n    <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> Setup python\n        <span class=\"token key atrule\">uses</span><span class=\"token punctuation\">:</span> actions/setup<span class=\"token punctuation\">-</span>python@v3\n        <span class=\"token key atrule\">with</span><span class=\"token punctuation\">:</span>\n        <span class=\"token key atrule\">python-version</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"3.8\"</span>\n\n    <span class=\"token comment\"># 리눅스 환경에 docker를 세팅하는 shell script를 실행</span>\n    <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> Setup Docker\n        <span class=\"token key atrule\">run</span><span class=\"token punctuation\">:</span> sh scripts/setup<span class=\"token punctuation\">-</span>docker.sh\n\n<span class=\"token key atrule\">deploy</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">runs-on</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span> self<span class=\"token punctuation\">-</span>hosted<span class=\"token punctuation\">,</span> label<span class=\"token punctuation\">-</span>go <span class=\"token punctuation\">]</span>\n    <span class=\"token comment\"># checkout job이 완료되었을 경우 동작하도록 의존관계를 설정 </span>\n    <span class=\"token key atrule\">needs</span><span class=\"token punctuation\">:</span> checkout\n    <span class=\"token key atrule\">if</span><span class=\"token punctuation\">:</span> $<span class=\"token punctuation\">{</span><span class=\"token punctuation\">{</span> github.event.pull_request.merged == true <span class=\"token punctuation\">}</span><span class=\"token punctuation\">}</span>\n    <span class=\"token key atrule\">steps</span><span class=\"token punctuation\">:</span>\n    <span class=\"token comment\"># ${{ secrets.* }} 변수를 사용하여 Settings > Secrets > Actions에 정의한 값을 가져오고</span>\n    <span class=\"token comment\"># .env파일을 생성하여 dev환경의 환경변수를 관리</span>\n    <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> Create env file\n        <span class=\"token key atrule\">run</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">|</span><span class=\"token scalar string\">\n        touch ${{ secrets.ENV_PATH }}\n        {\n            echo SECRET_KEY=\"\\\"${{ secrets.SECRET_KEY }}\"\\\"\n            echo RUN_ENV=\"\\\"${{ secrets.RUN_ENV }}\"\\\"\n            echo DOMAIN=\"\\\"${{ secrets.DOMAIN }}\"\\\"\n            echo PROD_ALLOWED_HOSTS='${{ secrets.PROD_ALLOWED_HOSTS }}'\n            echo CORS_ORIGIN_WHITELIST='${{ secrets.CORS_ORIGIN_WHITELIST }}'\n            ...\n        } >> ${{ secrets.ENV_PATH }}</span>\n\n    <span class=\"token comment\"># container를 빌드하고 배포하는 shell script를 수행</span>\n    <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> Build Docker containers\n        <span class=\"token key atrule\">run</span><span class=\"token punctuation\">:</span> sh scripts/build<span class=\"token punctuation\">-</span>docker<span class=\"token punctuation\">-</span>compose.sh\n\n    <span class=\"token comment\"># container의 동작 상태를 확인한 뒤 job을 종료</span>\n    <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> Check container running state\n        <span class=\"token key atrule\">run</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">|</span><span class=\"token scalar string\">\n        if [ $(docker ps --format \"{{.Names}} {{.Status}}\" | grep \"Up\" | wc -l) -ne 3 ]\n        then\n            echo \"Build error while running docker-compose\"\n            exit 1\n        else\n            echo \"Deploy Complete\"\n        fi</span>\n\n<span class=\"token key atrule\">rollback</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">runs-on</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span> self<span class=\"token punctuation\">-</span>hosted<span class=\"token punctuation\">,</span> label<span class=\"token punctuation\">-</span>go <span class=\"token punctuation\">]</span>\n    <span class=\"token comment\"># checkout, deploy job이 모두 완료되었을 경우 동작하도록 의존관계를 설정 </span>\n    <span class=\"token key atrule\">needs</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span> checkout<span class=\"token punctuation\">,</span> deploy <span class=\"token punctuation\">]</span>\n    <span class=\"token comment\"># 의존관계가 설정되어 있는 job들 중 하나라도 실패하였을 경우 동작하도록 조건 설정</span>\n    <span class=\"token key atrule\">if</span><span class=\"token punctuation\">:</span> $<span class=\"token punctuation\">{</span><span class=\"token punctuation\">{</span> always() <span class=\"token important\">&amp;&amp;</span> contains(needs.<span class=\"token important\">*.result</span><span class=\"token punctuation\">,</span> 'failure') <span class=\"token punctuation\">}</span><span class=\"token punctuation\">}</span>\n    <span class=\"token key atrule\">steps</span><span class=\"token punctuation\">:</span>\n    <span class=\"token comment\"># runner가 workflow를 수행할 수 있도록 workspace에 permission 부여</span>\n    <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> Set Action Runner Permissions\n        <span class=\"token key atrule\">run</span><span class=\"token punctuation\">:</span> sudo chown <span class=\"token punctuation\">-</span>R $USER<span class=\"token punctuation\">:</span>$USER $<span class=\"token punctuation\">{</span><span class=\"token punctuation\">{</span> github.workspace <span class=\"token punctuation\">}</span><span class=\"token punctuation\">}</span>\n\n    <span class=\"token comment\"># rollback job을 수행하기 위하여 마지막으로 release된 버전의 소스코드를 fetch</span>\n    <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> Fetch Latest Release\n        <span class=\"token key atrule\">id</span><span class=\"token punctuation\">:</span> fetch<span class=\"token punctuation\">-</span>latest\n        <span class=\"token key atrule\">uses</span><span class=\"token punctuation\">:</span> thebritican/fetch<span class=\"token punctuation\">-</span>latest<span class=\"token punctuation\">-</span>release@v1.0.3\n        <span class=\"token key atrule\">with</span><span class=\"token punctuation\">:</span>\n        <span class=\"token key atrule\">github_token</span><span class=\"token punctuation\">:</span> $<span class=\"token punctuation\">{</span><span class=\"token punctuation\">{</span> secrets.GITHUB_TOKEN <span class=\"token punctuation\">}</span><span class=\"token punctuation\">}</span>\n\n    <span class=\"token comment\"># fetch-latest step에서 fetch한 버전의 소스코드로 checkout</span>\n    <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> Checkout Latest Release source code\n        <span class=\"token key atrule\">uses</span><span class=\"token punctuation\">:</span> actions/checkout@v3\n        <span class=\"token key atrule\">with</span><span class=\"token punctuation\">:</span>\n        <span class=\"token key atrule\">ref</span><span class=\"token punctuation\">:</span> $<span class=\"token punctuation\">{</span><span class=\"token punctuation\">{</span> steps.fetch<span class=\"token punctuation\">-</span>latest.outputs.tag_name <span class=\"token punctuation\">}</span><span class=\"token punctuation\">}</span>\n\n    <span class=\"token comment\"># container를 빌드하고 배포하는 shell script를 수행</span>\n    <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> Build Docker containers\n        <span class=\"token key atrule\">run</span><span class=\"token punctuation\">:</span> sh scripts/build<span class=\"token punctuation\">-</span>docker<span class=\"token punctuation\">-</span>compose.sh\n\n    <span class=\"token comment\"># container의 동작 상태를 확인한 뒤 job을 종료</span>\n    <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> Check container running state\n        <span class=\"token key atrule\">run</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">|</span><span class=\"token scalar string\">\n        if [ $(docker ps --format \"{{.Names}} {{.Status}}\" | grep \"Up\" | wc -l) -ne 3 ]\n        then\n            echo \"Build error while running docker-compose\"\n            exit 1\n        else\n            echo \"Deploy Complete\"\n        fi</span></code></pre></div>\n</li>\n<li>\n<p><code class=\"language-text\">auto-release.yml</code></p>\n<ul>\n<li>pull request를 활용한 소스코드 release, tag 생성 및 관리 자동화</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\"><span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> Auto Release\n<span class=\"token key atrule\">on</span><span class=\"token punctuation\">:</span>  <span class=\"token comment\"># pull request가 opened / reopened / synchronize / edited / closed되었을 때 동작하는 workflow</span>\n<span class=\"token key atrule\">pull_request</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">types</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span>opened<span class=\"token punctuation\">,</span> reopened<span class=\"token punctuation\">,</span> synchronize<span class=\"token punctuation\">,</span> edited<span class=\"token punctuation\">,</span> closed<span class=\"token punctuation\">]</span>\n\n<span class=\"token key atrule\">jobs</span><span class=\"token punctuation\">:</span>\n<span class=\"token key atrule\">release</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">runs-on</span><span class=\"token punctuation\">:</span> ubuntu<span class=\"token punctuation\">-</span>latest\n    <span class=\"token comment\"># pull request가 target으로 하는 branch가 main일 경우에만 수행되도록 조건을 설정</span>\n    <span class=\"token key atrule\">if</span><span class=\"token punctuation\">:</span> $<span class=\"token punctuation\">{</span><span class=\"token punctuation\">{</span> contains(github.base_ref<span class=\"token punctuation\">,</span> 'main') <span class=\"token punctuation\">|</span><span class=\"token punctuation\">|</span> contains(github.ref<span class=\"token punctuation\">,</span> 'main') <span class=\"token punctuation\">}</span><span class=\"token punctuation\">}</span>\n    <span class=\"token key atrule\">steps</span><span class=\"token punctuation\">:</span>\n    <span class=\"token comment\"># workflow를 실행하기 위해 필요한 코드에 대해서만 sparse checkout 수행</span>\n    <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> Sparse<span class=\"token punctuation\">-</span>checkout\n        <span class=\"token key atrule\">uses</span><span class=\"token punctuation\">:</span> lablup/sparse<span class=\"token punctuation\">-</span>checkout@v1\n        <span class=\"token key atrule\">with</span><span class=\"token punctuation\">:</span>\n        <span class=\"token key atrule\">patterns</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">|</span><span class=\"token scalar string\">\n            scripts</span>\n    <span class=\"token comment\"># release할 version명을 output으로 저장하는 step 수행</span>\n    <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> Extract version\n        <span class=\"token key atrule\">id</span><span class=\"token punctuation\">:</span> extract<span class=\"token punctuation\">-</span>version\n        <span class=\"token key atrule\">run</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">|</span><span class=\"token scalar string\">\n        # release명은 pull request의 title에 명시된 '숫자.숫자.숫자' 포맷으로 설정\n        # 해당 규칙을 준수한 release명이 존재하지 않거나, 잘못된 값이 입력되어 있는 경우에는 이후의 step을 모두 skip\n        version=$(echo '${{ github.event.pull_request.title }}' | egrep -o '[0-9]{1,3}\\.[0-9]{1,3}\\.[0-9]{1,3}')\n        echo \"::set-output name=version::$version\"</span>\n\n    <span class=\"token comment\"># 현재 branch와 이전 버전 release 사이의 commit log들을 CHANGELOG_RELEASE.md에 저장하고</span>\n    <span class=\"token comment\"># 존재하던 CHANGELOG.md를 업데이트하는 python script를 실행</span>\n    <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> Auto Generate Changelog\n        <span class=\"token key atrule\">id</span><span class=\"token punctuation\">:</span> changelog\n        <span class=\"token key atrule\">if</span><span class=\"token punctuation\">:</span> $<span class=\"token punctuation\">{</span><span class=\"token punctuation\">{</span> steps.extract<span class=\"token punctuation\">-</span>version.outputs.version <span class=\"token punctuation\">}</span><span class=\"token punctuation\">}</span>\n        <span class=\"token key atrule\">run</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">|</span><span class=\"token scalar string\">\n        python3 ./scripts/generate_changelog.py --version \"${{ steps.extract-version.outputs.version }}\" --tag \"${{ github.head_ref }}\"</span>\n\n    <span class=\"token comment\"># CHANGELOG_RELEASE.md에 변경내용이 존재하는지, 즉 새로운 버전의 release를 생성할 필요가 있는지 확인</span>\n    <span class=\"token comment\"># 해당 workflow에서 설정한 github action(pull request)가 close되고,</span>\n    <span class=\"token comment\"># extract-version step에서 올바른 형태의 버전명을 얻어낸 경우에만 수행하도록 조건을 설정</span>\n    <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> Get Changed Files\n        <span class=\"token key atrule\">id</span><span class=\"token punctuation\">:</span> changed<span class=\"token punctuation\">-</span>files\n        <span class=\"token key atrule\">if</span><span class=\"token punctuation\">:</span> $<span class=\"token punctuation\">{</span><span class=\"token punctuation\">{</span> github.event.action <span class=\"token tag\">!=</span> 'closed' <span class=\"token important\">&amp;&amp;</span> steps.extract<span class=\"token punctuation\">-</span>version.outputs.version <span class=\"token punctuation\">}</span><span class=\"token punctuation\">}</span>\n        <span class=\"token key atrule\">uses</span><span class=\"token punctuation\">:</span> tj<span class=\"token punctuation\">-</span>actions/changed<span class=\"token punctuation\">-</span>files@v31\n\n    <span class=\"token comment\"># 이전 step인 changed-files에서 변경된 파일이 있는 경우, 파일을 staged 상태로 전환한뒤 자동으로 커밋</span>\n    <span class=\"token comment\"># 이 때, 커밋할 파일(CHANGELOG.md)과 커밋 메세지는 with 구문을 사용하여 지정 </span>\n    <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> Auto Commit Updated Changelog\n        <span class=\"token key atrule\">id</span><span class=\"token punctuation\">:</span> auto<span class=\"token punctuation\">-</span>commit<span class=\"token punctuation\">-</span>push\n        <span class=\"token key atrule\">if</span><span class=\"token punctuation\">:</span> $<span class=\"token punctuation\">{</span><span class=\"token punctuation\">{</span> github.event.action <span class=\"token tag\">!=</span> 'closed' <span class=\"token important\">&amp;&amp;</span> steps.changed<span class=\"token punctuation\">-</span>files.outputs.any_changed == true <span class=\"token important\">&amp;&amp;</span> steps.extract<span class=\"token punctuation\">-</span>version.outputs.version <span class=\"token punctuation\">}</span><span class=\"token punctuation\">}</span>\n        <span class=\"token key atrule\">uses</span><span class=\"token punctuation\">:</span> stefanzweifel/git<span class=\"token punctuation\">-</span>auto<span class=\"token punctuation\">-</span>commit<span class=\"token punctuation\">-</span>action@v4\n        <span class=\"token key atrule\">with</span><span class=\"token punctuation\">:</span>\n        <span class=\"token key atrule\">commit_message</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"update: CHANGELOG.md\"</span>\n        <span class=\"token key atrule\">file_pattern</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"CHANGELOG.md\"</span>\n\n    <span class=\"token comment\"># 조건을 만족하는 경우, 새로운 버전의 release와 tag를 생성</span>\n    <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> Create Release with Tag\n        <span class=\"token key atrule\">if</span><span class=\"token punctuation\">:</span> $<span class=\"token punctuation\">{</span><span class=\"token punctuation\">{</span> github.event.action == 'closed' <span class=\"token important\">&amp;&amp;</span> github.event.pull_request.merged == true <span class=\"token important\">&amp;&amp;</span> steps.extract<span class=\"token punctuation\">-</span>version.outputs.version == true <span class=\"token important\">&amp;&amp;</span> contains(github.event.pull_request.title<span class=\"token punctuation\">,</span> 'release') <span class=\"token punctuation\">}</span><span class=\"token punctuation\">}</span>\n        <span class=\"token key atrule\">uses</span><span class=\"token punctuation\">:</span> ncipollo/release<span class=\"token punctuation\">-</span>action@v1\n        <span class=\"token key atrule\">with</span><span class=\"token punctuation\">:</span>\n        <span class=\"token key atrule\">tag</span><span class=\"token punctuation\">:</span> $<span class=\"token punctuation\">{</span><span class=\"token punctuation\">{</span> steps.extract<span class=\"token punctuation\">-</span>version.outputs.version <span class=\"token punctuation\">}</span><span class=\"token punctuation\">}</span>\n        <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> $<span class=\"token punctuation\">{</span><span class=\"token punctuation\">{</span> steps.extract<span class=\"token punctuation\">-</span>version.outputs.version <span class=\"token punctuation\">}</span><span class=\"token punctuation\">}</span>\n        <span class=\"token key atrule\">bodyFile</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"./CHANGELOG_RELEASE.md\"</span>\n        <span class=\"token key atrule\">skipIfReleaseExists</span><span class=\"token punctuation\">:</span> <span class=\"token boolean important\">true</span></code></pre></div>\n</li>\n</ol>\n<br>\n<h2 id=\"마무리\" style=\"position:relative;\"><a href=\"#%EB%A7%88%EB%AC%B4%EB%A6%AC\" aria-label=\"마무리 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>마무리</h2>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 720px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 51.11111111111111%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAKCAYAAAC0VX7mAAAACXBIWXMAAAsTAAALEwEAmpwYAAABYElEQVQoz4WS63KCMBCFqSi3ACGSgIDlXnHs6Pu/3Wl3FarWTn+cOSGz+7GXWPnYYzheMEwX1P0RZT2iag/YdxO7LhpEKn+pMMlgihbNcELZfECZCpZpGrz3E/KqW2BFPSLfd9C7GokuEMQaQhoIqVn8HZOnDKE8UzSQaQFLZzXSvOagILoGe+EWUaKxbwY4fgTbCWDZLmvlBFBZxQpVBpEYOEJyjCcSWPX5jO7wiaxsYcqGnf7kBhIy3SGIthz8tvZu8mE74qZg8RUDFaxqmtCOJ8TbHaQuGEbz2XgRlKGzgRvEXB0DbW+p9l6rjQ8vVLCyouXB0ozmQZM2PgFLxCpDKDU2XvgDfRLdc8sEpG3SlmbY7FQhLSRKzBW2ch4Az8ClQtpSvu+51QcgVUhAGnyccsIr2C8gJVO797D7lmmGQqbwQ8VJfwGXlp8f6gxeuyE8IeEKeQX90zK5+/1svgCkAem80os1pQAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"cicd-005.png\"\n        title=\"cicd-005.png\"\n        src=\"/static/455b5059cc40b360be2fa353138286b2/37523/cicd-005.png\"\n        srcset=\"/static/455b5059cc40b360be2fa353138286b2/e9ff0/cicd-005.png 180w,\n/static/455b5059cc40b360be2fa353138286b2/f21e7/cicd-005.png 360w,\n/static/455b5059cc40b360be2fa353138286b2/37523/cicd-005.png 720w,\n/static/455b5059cc40b360be2fa353138286b2/a0b80/cicd-005.png 955w\"\n        sizes=\"(max-width: 720px) 100vw, 720px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n    </span><em>workflow 수행결과</em></p>\n<p>이렇게 <code class=\"language-text\">Github Action</code>을 사용하여 빌드 및 배포뿐만 아니라 버전관리까지 자동화할 수 있었다.\n<code class=\"language-text\">YAML</code> 문법을 사용하여 workflow를 작성할 수 있고 github 공식 도큐먼트가 매우 잘 정리되어 있어서 활용이 매우 편리했다.\n다음에는 자동화하고 싶은 action을 직접 github marketplace에 배포해보는 것이 목표다!</p>\n<br>\n<div class=\"table-of-contents\">\n<ul>\n<li><a href=\"#cicd-%ED%94%84%EB%A1%9C%EC%84%B8%EC%8A%A4-%EC%84%A4%EA%B3%84%ED%95%B4%EB%B3%B4%EA%B8%B0\">CI/CD 프로세스 설계해보기</a></li>\n<li><a href=\"#github%EB%A5%BC-%ED%99%9C%EC%9A%A9%ED%95%9C-cicd-%ED%99%98%EA%B2%BD-%EA%B4%80%EB%A6%AC\">Github를 활용한 CI/CD 환경 관리</a></li>\n<li><a href=\"#workflow-%EA%B5%AC%ED%98%84%ED%95%98%EA%B8%B0\">Workflow 구현하기</a></li>\n<li><a href=\"#%EB%A7%88%EB%AC%B4%EB%A6%AC\">마무리</a></li>\n</ul>\n</div>","frontmatter":{"date":"December 16, 2022","title":"Github Action으로 EC2에서 배포 자동화하기","categories":"DevOps ci/cd Github","author":"소희","emoji":"🗣"},"fields":{"slug":"/github/ci-cd/"}},"site":{"siteMetadata":{"siteUrl":"https://soheeeep.github.io","comments":{"utterances":{"repo":"https://github.com/soheeeeP/soheeeep.github.io"}}}}},"pageContext":{"slug":"/opensource/backend.ai/hotfix/","nextSlug":"/opensource/backend.ai/image-typo/","prevSlug":"/github/ci-cd/"}},"staticQueryHashes":["1073350324","1956554647","2938748437"]}
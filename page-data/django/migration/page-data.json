{
    "componentChunkName": "component---src-templates-blog-template-js",
    "path": "/django/migration/",
    "result": {"data":{"cur":{"id":"c1198dc0-ed7e-5c80-af52-2abfb0e265a7","html":"<p>기능을 추가하며 모델을 변경해야 할 일이 새겼다.\n테이블을 수정하고 migration을 적용하면서 dependency 오류부터 relationExists 오류까지 아주 난항을 겪었다.</p>\n<p>사실 토이프로젝트에서는 migration이 꼬이면 그냥 전부 밀어버리고 다시 적용하면 그만이었다.\n하지만 실제로 배포되고 데이터가 담겨 있는 DB의 테이블을 수정하는 경우에는 이런 1차원적인 방식으로 접근할 수는 없었다.</p>\n<p>다소 긴 삽질의 과정을 경험하며, 내가 migration에 대하여 정확히 이해를 하지 못하고 있음을 깨달았다.</p>\n<br>\n<h2 id=\"migration이란\" style=\"position:relative;\"><a href=\"#migration%EC%9D%B4%EB%9E%80\" aria-label=\"migration이란 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Migration이란?</h2>\n<p>일종의 database version control log라고 이해하면 될 것 같다.\n<code class=\"language-text\">python manage.py makemigrations</code> 명령어를 수행하면 각 app의 모델에 대한 변경사항을 기록한 python script가 자동으로 생성되고</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">$ python manage.py makemigrations <span class=\"token punctuation\">[</span>app_name<span class=\"token punctuation\">]</span>\nMigrations <span class=\"token keyword\">for</span> <span class=\"token string\">'users'</span><span class=\"token builtin class-name\">:</span>\n  apps/users/migrations/0002_user_auth_id_user_social_type.py\n    - Add field auth_id to <span class=\"token function\">users</span>\n    - Add field social_type to <span class=\"token function\">users</span></code></pre></div>\n<p><code class=\"language-text\">python manage.py migrate</code> 명령어를 수행하면 db에 변경사항을 반영할 수 있다.\n이 migration script는 <code class=\"language-text\">000X_changelog_contents_whatever.py</code> 형식으로 네이밍되며,\n모델 간의 관계(생성 순서, 참조 방향 등)를 고려하여 순차적으로 dependency가 존재한다.</p>\n<p>예를 들어, <code class=\"language-text\">BookObject</code> 테이블에서 <code class=\"language-text\">User</code> 테이블을 FK로 참조하고 있는 경우라면\n반드시 <code class=\"language-text\">User</code> 테이블의 생성이 선행되어야만 <code class=\"language-text\">BookObject</code> 테이블을 참조할 수 있다.</p>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\"><span class=\"token keyword\">class</span> <span class=\"token class-name\">User</span><span class=\"token punctuation\">(</span>AbstractUser<span class=\"token punctuation\">,</span> TimeStampModel<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n    username <span class=\"token operator\">=</span> <span class=\"token boolean\">None</span>\n    email <span class=\"token operator\">=</span> models<span class=\"token punctuation\">.</span>EmailField<span class=\"token punctuation\">(</span>\n        max_length<span class=\"token operator\">=</span><span class=\"token number\">255</span><span class=\"token punctuation\">,</span>\n        verbose_name<span class=\"token operator\">=</span><span class=\"token string\">'이메일'</span><span class=\"token punctuation\">,</span>\n        validators<span class=\"token operator\">=</span><span class=\"token punctuation\">[</span>SpecificEmailDomainValidator<span class=\"token punctuation\">(</span>allowlist<span class=\"token operator\">=</span>domain_allowlist<span class=\"token punctuation\">)</span><span class=\"token punctuation\">]</span>\n    <span class=\"token punctuation\">)</span>\n    \n<span class=\"token keyword\">class</span> <span class=\"token class-name\">BookObject</span><span class=\"token punctuation\">(</span>TimeStampModel<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n    user <span class=\"token operator\">=</span> models<span class=\"token punctuation\">.</span>ForeignKey<span class=\"token punctuation\">(</span>\n        User<span class=\"token punctuation\">,</span>\n        on_delete<span class=\"token operator\">=</span>models<span class=\"token punctuation\">.</span>CASCADE<span class=\"token punctuation\">,</span>\n        related_name<span class=\"token operator\">=</span><span class=\"token string\">'note'</span><span class=\"token punctuation\">,</span>\n        verbose_name<span class=\"token operator\">=</span><span class=\"token string\">'작성자'</span>\n    <span class=\"token punctuation\">)</span></code></pre></div>\n<p>따라서 <code class=\"language-text\">BookObject</code> app의 migration에는 다음과 같은 dependency(<code class=\"language-text\">users.migrations.0001_initial.py</code> 을 적용한 후에 해당 migration을 적용할 수 있음)가 명시되어 있다.</p>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\"><span class=\"token keyword\">class</span> <span class=\"token class-name\">Migration</span><span class=\"token punctuation\">(</span>migrations<span class=\"token punctuation\">.</span>Migration<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n    initial <span class=\"token operator\">=</span> <span class=\"token boolean\">True</span>\n    dependencies <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span>\n        <span class=\"token punctuation\">(</span><span class=\"token string\">'users'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'0001_initial'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">]</span></code></pre></div>\n<br>\n<h2 id=\"적용된-migration-확인하기\" style=\"position:relative;\"><a href=\"#%EC%A0%81%EC%9A%A9%EB%90%9C-migration-%ED%99%95%EC%9D%B8%ED%95%98%EA%B8%B0\" aria-label=\"적용된 migration 확인하기 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>적용된 migration 확인하기</h2>\n<p>migration 적용 내역은 <code class=\"language-text\">django_migrations</code> 테이블에 저장되는데\n이 때 데이터베이스에 migration 내용은 저장되지 않는다. 적용 순서, script명, 시간 정도의 데이터만 확인할 수 있다.</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 654px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 40.55555555555556%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAICAYAAAD5nd/tAAAACXBIWXMAAAsTAAALEwEAmpwYAAABpklEQVQoz02QS4/TMBRG82OAPtLntI0TO7Gd2EnbZNIWNKOO0GxY8VgiJHazmS0rfgH/9KB4ALE4sq/96d5jRxvrUDZjk6zYZmtukiVCCaRJkUpircP5JuD/rAFX4yqHtdXL3jcYUxJtRYI8OL58+877Tx/ZeotwmrnNkb7GH24xTYttOsp9hx1oWsr2Qnm60t89UHdndN0ifUd0//DI0/NPnn784vPXZ0zTcWjPJLqh7i5Y55mvN8xWAzdhjZdrpqsdwrV053dYV5Nbh9COyJ+vXB8/MI1jEiHQuUIpiUi2lMZgjCEVgt12S7LbBebzGW9evyITCblSaF1Qe49MBVHlPXV7Io6nGK2pnGM0GrFer+n7E03ThKZaG/KiQGsd2O2ScLbf70Om73tsWRJJ42gvd0ynU4QQpGnGeDxmvlhQliV5nqPyPDQpiiI0Xy6XYeiQV0oFrLUIkRJJlYeGcRyHsPvP8Hy5cDweg0XXdYHBZjabhcwwZKjrv4bWErW3Pd3beyaTCVmWIaUMhovFgqqqguHLk/U/yyEz2A354X74irKqQv0b7HkWVto5kqAAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"migration-001.png\"\n        title=\"migration-001.png\"\n        src=\"/static/79119921aca3628b1ab042b232a4fbe6/68e9c/migration-001.png\"\n        srcset=\"/static/79119921aca3628b1ab042b232a4fbe6/e9ff0/migration-001.png 180w,\n/static/79119921aca3628b1ab042b232a4fbe6/f21e7/migration-001.png 360w,\n/static/79119921aca3628b1ab042b232a4fbe6/68e9c/migration-001.png 654w\"\n        sizes=\"(max-width: 654px) 100vw, 654px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n    </span></p>\n<p>따라서 이미 적용된 migration script를 수정한 뒤 다시 migrate를 수행한다고 해도 <code class=\"language-text\">django_migration</code> 테이블에 변경 내용은 저장되지 않는다.\n데이터베이스에 수정 내용이 반영되지 않고 충돌이 일어날 수도 있다.</p>\n<p><code class=\"language-text\">python manage.py showmigrations</code> 를 통해서도 한눈에 migration 적용상태를 확인할 수 있다.</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 720px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 75.55555555555556%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAPCAYAAADkmO9VAAAACXBIWXMAABYlAAAWJQFJUiTwAAACWElEQVQ4y6WUy27TQBSG7ahICAFCdS7jxk7jS+w0vsTjmfjWum6q0lYgJF6Fp2DHA/AiLKALGtixYolALHmEyjD4oHFTU0qDKmHp1z9Htr85l7GFF8/mwtMi2tw/iGmWZMF2kuIsSXCWpLjYyfHx4RE+mO/j44eH+Mmjx3he7OE0Pr+/naY4jWM8LwpyfHQ0EpZX6yAlr/K9CIIgPKOElJTQEge4TNOszHfyMs93y2K3qNdpkpYhDutnwrD2M8/1YLK19XFtbe0uB952vOl738dgWXY11DRQFAVUdQB9RQGEEMiyDEiWodfr1euNjY1a8rlXPYSg0+l8bbVanXOg45yGhAAOyQ/X9arJxKkc1634BoPBoJJluUIINX5FrN4Qoc+iKLZroOt6izAk4Hk+s8djMM0RGKbJM66dv/AP/VwCvzRAwzQXhM54hsz3p4BxCDx2HBf6/f7vspd+WQihv4GWZS0onUEQYOZ6PvjTAAihYNvjpmfXwVYC7fF4kaQZUDpjQYCBziKIorh2HiuXhnPDDO3FLIohihNGKYclkGbbEIYUNofDVaWuBjp8KITyITDTNEHXDeCu6XoDvBA/Opd7ujJDDnQ9j2ma3vSND4SfRaWRCqqq/tHTa4Fbk8nbvJjDLErKOsvRiHEfWRYzzRHTdZ1pus50w6hjVVXZ8vxx/74EfmqAvud9INMA/MmkLnU41MAwjDqjixKvK/lKT7+Jolh/KbcG3e5zs9t+Z3fbr7uSdLK+vn4iSdJN9UaSpFNJkl4KgnBf8B/c49A7giC0/1P8xyD+AtusTtEftjpwAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"migration-002.png\"\n        title=\"migration-002.png\"\n        src=\"/static/38c649a1c8172d2f564b963ba7007f55/37523/migration-002.png\"\n        srcset=\"/static/38c649a1c8172d2f564b963ba7007f55/e9ff0/migration-002.png 180w,\n/static/38c649a1c8172d2f564b963ba7007f55/f21e7/migration-002.png 360w,\n/static/38c649a1c8172d2f564b963ba7007f55/37523/migration-002.png 720w,\n/static/38c649a1c8172d2f564b963ba7007f55/302a4/migration-002.png 1080w,\n/static/38c649a1c8172d2f564b963ba7007f55/07a9c/migration-002.png 1440w,\n/static/38c649a1c8172d2f564b963ba7007f55/24def/migration-002.png 1812w\"\n        sizes=\"(max-width: 720px) 100vw, 720px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n    </span></p>\n<p><br><br></p>\n<h2 id=\"이미-적용된-migration을-revert하고-싶은-경우\" style=\"position:relative;\"><a href=\"#%EC%9D%B4%EB%AF%B8-%EC%A0%81%EC%9A%A9%EB%90%9C-migration%EC%9D%84-revert%ED%95%98%EA%B3%A0-%EC%8B%B6%EC%9D%80-%EA%B2%BD%EC%9A%B0\" aria-label=\"이미 적용된 migration을 revert하고 싶은 경우 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>이미 적용된 migration을 Revert하고 싶은 경우?</h2>\n<p>아래와 같이 Revert하고자 하는 app의 이름과 migration 번호를 명시하면 된다.</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">$ python manage.py migrate <span class=\"token punctuation\">[</span>app_name<span class=\"token punctuation\">]</span> <span class=\"token punctuation\">[</span>number<span class=\"token punctuation\">]</span>\n</code></pre></div>\n<p>예를 들어 0004까지 migration이 적용되어 있는 User app이 있다고 하자.\n<code class=\"language-text\">python manage.py migrate users 0002</code> 라는 명령을 수행하면, 0003 이후의 migration은 unapply되고 0002 migration 기준으로 데이터베이스가 동작한다</p>\n<p>이 때, 주의하여야 할 점은 되돌리고자 시점 이후에 대한 migration script를 절대 삭제해서는 안된다는 것이다!\n데이터베이스는 사용자가 입력한 명령을 <b>존재하지도 않는 migration을 revert하려는 것</b>으로 이해할 것이다.\n삭제된 migration을 복구할 수 없는 경우라면 직접 데이터베이스의 테이블을 수정해야 한다.</p>\n<br>\n<h2 id=\"이미-적용된-migration-내용을-수정하고-싶은-경우\" style=\"position:relative;\"><a href=\"#%EC%9D%B4%EB%AF%B8-%EC%A0%81%EC%9A%A9%EB%90%9C-migration-%EB%82%B4%EC%9A%A9%EC%9D%84-%EC%88%98%EC%A0%95%ED%95%98%EA%B3%A0-%EC%8B%B6%EC%9D%80-%EA%B2%BD%EC%9A%B0\" aria-label=\"이미 적용된 migration 내용을 수정하고 싶은 경우 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>이미 적용된 migration 내용을 수정하고 싶은 경우?</h2>\n<p>n번째 migration 적용 내역을 수정하고 싶다면 어떻게 하면 될까?\nn+1번째의 새로운 migration script를 생성하면 된다. 위에 언급한 것처럼\n이미 적용된 migration을 수정하는 것은 데이터베이스에 충돌을 불러올 수도 있고, 이후에 적용할 migration에서 충돌이 발생할 수도 있다.</p>\n<p>그래도 n번째로 적용된 migration을 수정하는 방향으로 개발을 하고 싶다면,\n이전 n-1번째 version으로 revert를 수행한뒤에 새롭게 n번째 migration script를 생성하고 적용하면 된다.</p>\n<br>\n<h2 id=\"migration을-squash하여-log를-관리하고-싶은-경우\" style=\"position:relative;\"><a href=\"#migration%EC%9D%84-squash%ED%95%98%EC%97%AC-log%EB%A5%BC-%EA%B4%80%EB%A6%AC%ED%95%98%EA%B3%A0-%EC%8B%B6%EC%9D%80-%EA%B2%BD%EC%9A%B0\" aria-label=\"migration을 squash하여 log를 관리하고 싶은 경우 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>migration을 Squash하여 log를 관리하고 싶은 경우?</h2>\n<p><code class=\"language-text\">python manage.py squashmigrations</code>를 사용하여\n존재하는 많은 수의 migration을 한 개(또는 그 이상)의 migration으로 합쳐서 관리할 수 있다.</p>\n<p>예를 들어 <code class=\"language-text\">CreateModel</code>과 <code class=\"language-text\">DeleteModel</code> action을 합칠 수 있고, <code class=\"language-text\">AddField</code> action을 <code class=\"language-text\">CreateModel</code> 내부로 roll 시킬 수 있을 것이다.</p>\n<p>squash된 migration과 이전 버전의 migration log는 동시에 존재할 수 있다.\nDjango는 migration이 적용되는 시점을 자동으로 파악하여 새로운 version에서는 squash된 migration을 적용하고 이전 버전의 migration을 skip한다.</p>\n<p><code class=\"language-text\">--squashed-name</code> 옵션을 사용하여 squash할 migration script의 이름을 지정할 수도 있다.</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">$ python manage.py squashmigrations <span class=\"token punctuation\">[</span>app_name<span class=\"token punctuation\">]</span> <span class=\"token punctuation\">[</span>number<span class=\"token punctuation\">]</span> <span class=\"token parameter variable\">--squaushed_name</span> <span class=\"token punctuation\">[</span>SQUASHED_NAME<span class=\"token punctuation\">]</span>\nWill squash the following migrations:\n - 0001_initial\n - 0002_some_change\n - 0003_another_change\n - 0004_undo_something\nDo you wish to proceed? <span class=\"token punctuation\">[</span>y/N<span class=\"token punctuation\">]</span> y\nOptimizing<span class=\"token punctuation\">..</span>.\n  Optimized from <span class=\"token number\">12</span> operations to <span class=\"token number\">7</span> operations.\nCreated new squashed migration /home/andrew/Programs/DjangoTest/test/migrations/0001_squashed_0004_undo_somthing.py\n  You should commit this migration but leave the old ones <span class=\"token keyword\">in</span> place<span class=\"token punctuation\">;</span>\n  the new migration will be used <span class=\"token keyword\">for</span> new installs. Once you are sure\n  all instances of the codebase have applied the migrations you squashed,\n  you can delete them.</code></pre></div>\n<br>\n<div class=\"table-of-contents\">\n<ul>\n<li><a href=\"#migration%EC%9D%B4%EB%9E%80\">Migration이란?</a></li>\n<li><a href=\"#%EC%A0%81%EC%9A%A9%EB%90%9C-migration-%ED%99%95%EC%9D%B8%ED%95%98%EA%B8%B0\">적용된 migration 확인하기</a></li>\n<li><a href=\"#%EC%9D%B4%EB%AF%B8-%EC%A0%81%EC%9A%A9%EB%90%9C-migration%EC%9D%84-revert%ED%95%98%EA%B3%A0-%EC%8B%B6%EC%9D%80-%EA%B2%BD%EC%9A%B0\">이미 적용된 migration을 Revert하고 싶은 경우?</a></li>\n<li><a href=\"#%EC%9D%B4%EB%AF%B8-%EC%A0%81%EC%9A%A9%EB%90%9C-migration-%EB%82%B4%EC%9A%A9%EC%9D%84-%EC%88%98%EC%A0%95%ED%95%98%EA%B3%A0-%EC%8B%B6%EC%9D%80-%EA%B2%BD%EC%9A%B0\">이미 적용된 migration 내용을 수정하고 싶은 경우?</a></li>\n<li><a href=\"#migration%EC%9D%84-squash%ED%95%98%EC%97%AC-log%EB%A5%BC-%EA%B4%80%EB%A6%AC%ED%95%98%EA%B3%A0-%EC%8B%B6%EC%9D%80-%EA%B2%BD%EC%9A%B0\">migration을 Squash하여 log를 관리하고 싶은 경우?</a></li>\n</ul>\n</div>","excerpt":"기능을 추가하며 모델을 변경해야 할 일이 새겼다.\n테이블을 수정하고 migration을 적용하면서 dependency 오류부터 relationExists 오류까지 아주 난항을 겪었다. 사실 토이프로젝트에서는 migration이 꼬이면 그냥 전부 밀어버리고 다시 적용하면 그만이었다.\n하지만 실제로 배포되고 데이터가 담겨 있는 DB의 테이블을 수정하는 경우에는 이런 1차원적인 방식으로 접근할 수는 없었다. 다소 긴 삽질의 과정을 경험하며, 내가 migration에 대하여 정확히 이해를 하지 못하고 있음을 깨달았다. Migration이란? 일종의 database version control log라고 이해하면 될 것 같다.\n 명령어를 수행하면 각 app의 모델에 대한 변경사항을 기록한 python script가 자동으로 생성되고  명령어를 수행하면 db에 변경사항을 반영할 수 있다.\n이 migration script는  형식으로 네이밍되며,\n모델 간의 관계(생성 순서, 참조 방향 등)를…","frontmatter":{"date":"December 30, 2022","title":"Django에서 migration으로 테이블 관리하기","categories":"웹 프레임워크","author":"소희","emoji":"🐤"},"fields":{"slug":"/django/migration/"}},"next":{"id":"16804f52-497a-59a5-92f4-51f8aa8d7bdd","html":"<p>Github Action은 <b>build, test, deployment와 같은 workflow를 자동화할 수 있는 CI/CD 플랫폼</b>으로,\ngithub repository에서 발생하는 모든 이벤트(push, pull request, merge 등)에 대하여 정해진 동작을 실행시키도록 할 수 있다.</p>\n<p>진행중인 프로젝트에서는 <code class=\"language-text\">docker-compose</code>를 이용해 서비스 컨테이너들을 관리하고 있다.\n소스코드가 수정될 때마다 수동으로 컨테이너를 삭제하고 빌드하는 방식으로 테스트 서버를 운영하다가 <code class=\"language-text\">Github Action</code>을 사용하여 CI/CD를 자동화해보기로 했다.</p>\n<br>\n<h2 id=\"cicd-프로세스-설계해보기\" style=\"position:relative;\"><a href=\"#cicd-%ED%94%84%EB%A1%9C%EC%84%B8%EC%8A%A4-%EC%84%A4%EA%B3%84%ED%95%B4%EB%B3%B4%EA%B8%B0\" aria-label=\"cicd 프로세스 설계해보기 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>CI/CD 프로세스 설계해보기</h2>\n<p>다음과 같은 프로세스들을 자동화시키려 하였다.</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 720px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 33.33333333333333%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAHCAYAAAAIy204AAAACXBIWXMAAAsTAAALEwEAmpwYAAABZklEQVQoz0WRu27cMBBF1TrepyRKosSHRL210nph2EkQpEqbMk2ANKkC5P8/4ASkg3VxwcE87gwOo26+YdxErBZS98JZryRqJjErdX+hn584pSUP+4THQ8rDLiYrG7bnzxg348Yr8/UVUdZI0xFdbh9x0xXlFky/YYcrql3Q7SUYNsOKbmeqeqCsJ3I7UeiW0g5I02O6BdstuHFDu4no+dNX6mG7J7vlFozqwWsN8gu9cVjWP5ErR1wYMuWomjHIzylvmFUtHw4ph7hgd8pC/HgUId6f8/DuTiLEvufoJRSHRL7Xz3mY8fXox68/FKoJFyS5/m+QBSal6ZC6pWoWctWSlTWptKRqZB/Le+8xkQGJkJbo5++/aDeimpGsaohzzUlUlLYPGHy+ajcy1b6ZeZWOODecRRV6PYK6X98+5cu372HYM/AMRdWQFAZp+zsfb+r5eIXPcStCdSTSkEgbrtduptAd/wAJUL4ZAyd6vgAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"cicd-001.png\"\n        title=\"cicd-001.png\"\n        src=\"/static/d4c07304f7de23c847b09043b3f9be09/37523/cicd-001.png\"\n        srcset=\"/static/d4c07304f7de23c847b09043b3f9be09/e9ff0/cicd-001.png 180w,\n/static/d4c07304f7de23c847b09043b3f9be09/f21e7/cicd-001.png 360w,\n/static/d4c07304f7de23c847b09043b3f9be09/37523/cicd-001.png 720w,\n/static/d4c07304f7de23c847b09043b3f9be09/c483d/cicd-001.png 751w\"\n        sizes=\"(max-width: 720px) 100vw, 720px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n    </span><em>github/workflow에 YAML파일 생성</em></p>\n<ol>\n<li>생성된 pull request에 대하여 <b>자동으로 build 테스트를 수행</b> → 실패시 merge 불가</li>\n<li>main branch에 pull request가 merge된 경우,\na) production 서버에 동작하던 컨테이너를 중지 / dangling image를 삭제하여 서버 여유공간 확보\nb) production 서버에 <b>새로운 container들을 빌드</b>\nc) container가 정상적으로 동작하지 않는 경우, <b>rollback</b></li>\n<li>pull request를 활용한 소스코드 <b>release, tag 생성 및 관리 자동화</b></li>\n</ol>\n<br>\n<h2 id=\"github를-활용한-cicd-환경-관리\" style=\"position:relative;\"><a href=\"#github%EB%A5%BC-%ED%99%9C%EC%9A%A9%ED%95%9C-cicd-%ED%99%98%EA%B2%BD-%EA%B4%80%EB%A6%AC\" aria-label=\"github를 활용한 cicd 환경 관리 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Github를 활용한 CI/CD 환경 관리</h2>\n<p><code class=\"language-text\">Repository > Settings > Secrets</code>를 사용하여 환경변수를 세팅한다.\nworkflow에서 env 파일을 생성하고 비밀키 값들을 넘겨주는 방식으로 관리했다.</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 720px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 70.55555555555556%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAOCAYAAAAvxDzwAAAACXBIWXMAAAsTAAALEwEAmpwYAAACLElEQVQ4y2WU2XLaQBBF9eg4rEL7LBqBYJBAYMCk7KosT/mRPCX//wE3dVvIhe2HqS7Ro9unb7cIosyirFuEicZolmA8T/F1GiPOSzTdM5a+w3Z/QaaXeBiFknucRnj4Mof+3eD87xdOf37g+Pc71E+PgIKL1IrQcCg8jxW08yhsDV155LYW0aRwyMwKuV5BdR72W4vqpYN73WPuNIIwNXDrHUzlYZdbaLfB4yRCqhx2x2f49oj90xXN/oz2cMHueEV3fsHh8oq1f0KaVtDGQ6k1JrMMAVuN8lIqz6JC6EbTGGFWwmxO0PUR1p9h/BnWX6CqBrlZQbmNEBdl3dObJdhtQKHN7oSiXGMcZhjdWp5GCmnZIC23EmPjEemNFKId80R/OtOo6D0sV42YPQyFkbTb7iLF1u0TUl1hkRnEyiEqnHQlsXCIeVQF2ieE7eGKwq5FdBjMJMykBZKb5VY2gZG/06ZUBlTJHbbu6p2Qi+DKd/JwP2VGXqZfjMyT+q0YCbMSYWJkxViY+SC+IXOyFOopE3mJF2k+L360hIJx7oSWpKba9oJMsJVhbdjaQEJ6u2yE7t4OHooRZJGa94JxZtEeryLUE2RvJAt6aGs5JL4XZK5vWb9v2dQHWWC+RK/i206SqvewFvrpIn8rNPgr3n5seZFX8LuTtE0RVuShAMX1nYf3hL2HPWGqKthVg1mkEIxniYjx+xyMH0hYgB5R/F5syA2T538B14j3/gPVb27Lq9MSqgAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"cicd-002.png\"\n        title=\"cicd-002.png\"\n        src=\"/static/f7f9e86e3dca7ad341667b65a4dadf64/37523/cicd-002.png\"\n        srcset=\"/static/f7f9e86e3dca7ad341667b65a4dadf64/e9ff0/cicd-002.png 180w,\n/static/f7f9e86e3dca7ad341667b65a4dadf64/f21e7/cicd-002.png 360w,\n/static/f7f9e86e3dca7ad341667b65a4dadf64/37523/cicd-002.png 720w,\n/static/f7f9e86e3dca7ad341667b65a4dadf64/c8e86/cicd-002.png 758w\"\n        sizes=\"(max-width: 720px) 100vw, 720px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n    </span></p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 587px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 48.33333333333333%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAKCAYAAAC0VX7mAAAACXBIWXMAAAsTAAALEwEAmpwYAAABdElEQVQoz4WS2W7CMBBFeS5LQmJnc0lCFgJhX1SWUkClaqW+VO3//8utZiICtEg8HNmeia/vzKTidCLo0kNNt9AwXWjCO6+Gi3rTvoK+I/7GT1TUIIEdh3DDHlQyhBNksP0O3HYPwovwUDdRbYgCTV4J3xbspwj7M6TjLfxsCtvPYLVSuO2cUfGQz4RQ8X2HThpBdTMIFcEJe+yULjetFmM4AXT5yGhC3RekJPXRaiWQKmaoVM2kvkpUNcFrwW2hyzgLWn6KaLBEqzPhNZ1ukT8dEXTnV4OoabIUr2ryn1vas6BhBxBeG6YbnqGzE0KXiqdN5RZle7yndtDfQEI0MHqkcKhJNG0f8XCN6eELg80Hsvke/dU78uUbOrMdkvEG2WzHudH2E9lsX+SmL0jGz9x7MlU61IXiaUbDFeLRmqdN5Z+geJgv4EX9sr8NwyndEnRmQeqFYftIJ1vMX7/ZATki4e7igPnxh53RIyRQlGddcD2wX9t3BlBmSdckAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"cicd-003.png\"\n        title=\"cicd-003.png\"\n        src=\"/static/3eca43c9227b3ee47247ddc66f09a18c/d72eb/cicd-003.png\"\n        srcset=\"/static/3eca43c9227b3ee47247ddc66f09a18c/e9ff0/cicd-003.png 180w,\n/static/3eca43c9227b3ee47247ddc66f09a18c/f21e7/cicd-003.png 360w,\n/static/3eca43c9227b3ee47247ddc66f09a18c/d72eb/cicd-003.png 587w\"\n        sizes=\"(max-width: 587px) 100vw, 587px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n    </span></p>\n<p>아래와 같이 repository에 Self-Hosted Runner를 등록하여 관리 중인 서버에서 자동으로 빌드와 배포를 수행하도록 하였다.\nrunner는 프로젝트의 EC2 instance에서 daemon으로 동작하고 있다.</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 720px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 40.55555555555556%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAICAYAAAD5nd/tAAAACXBIWXMAAAsTAAALEwEAmpwYAAABTUlEQVQoz11R2W7CQAzcR8SRkGuPJHsQYIGQCFGpUvvQH2lf+v8/MZWtbot4GNnWrscztihlD7s7oVIW661EVmqs8obreL3DH0YssxqrR+Q1lqsKuTO4fL7i+vWG6fsd/ccZojYesg1MkkDEpbLYxQluf4G2e+h+D+0iQ9kjlI0wwxn+ZUa4X2FvZxSuhyiajhV2PjJad2DCbd1CdTsmav0R2h3RuBEyTGj8BBlmSD+jVAdscoVNprDOJARZNu6AfndiAiLaFAp5ZdD6CHJQyJ4VV4piz/EPxsHQsC7wH0G7GuIM1Q+sLIF2SZYr1WGxyrBYZqi05eZaezRt4LguFKQNaEzAptQQlXYYTjPIOu2P1CWQWtofkachpJxiQnJDoFxQE12zMZ4vSI2JkPLnIen9+V+qhQ4j4nhDF+LvEQZoO7Dix+bHpseaUfznP9o9zMdxKmyvAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"cicd-004.png\"\n        title=\"cicd-004.png\"\n        src=\"/static/fcf2e12f372d71ede39c7e5f620fe06c/37523/cicd-004.png\"\n        srcset=\"/static/fcf2e12f372d71ede39c7e5f620fe06c/e9ff0/cicd-004.png 180w,\n/static/fcf2e12f372d71ede39c7e5f620fe06c/f21e7/cicd-004.png 360w,\n/static/fcf2e12f372d71ede39c7e5f620fe06c/37523/cicd-004.png 720w,\n/static/fcf2e12f372d71ede39c7e5f620fe06c/3c051/cicd-004.png 760w\"\n        sizes=\"(max-width: 720px) 100vw, 720px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n    </span></p>\n<br>\n<h2 id=\"workflow-구현하기\" style=\"position:relative;\"><a href=\"#workflow-%EA%B5%AC%ED%98%84%ED%95%98%EA%B8%B0\" aria-label=\"workflow 구현하기 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Workflow 구현하기</h2>\n<ol>\n<li>\n<p><code class=\"language-text\">build.yml</code></p>\n<ul>\n<li>생성된 pull request에 대하여 자동으로 build 테스트를 수행하는 workflow</li>\n<li>ubuntu 환경 구성 / container의 동작을 관리하는 shell script를 수행하는 step을 실행하도록 구현</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\"><span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> Build Test\n<span class=\"token key atrule\">on</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span>pull_request<span class=\"token punctuation\">]</span>  <span class=\"token comment\"># pull request event에 대하여 trigger되는 workflow</span>\n<span class=\"token key atrule\">jobs</span><span class=\"token punctuation\">:</span>\n<span class=\"token key atrule\">build</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">runs-on</span><span class=\"token punctuation\">:</span> ubuntu<span class=\"token punctuation\">-</span>latest\n    <span class=\"token key atrule\">steps</span><span class=\"token punctuation\">:</span>\n    <span class=\"token comment\"># 프로젝트 소스코드를 리눅스 환경에 checkout하고 실행하도록 명시</span>\n    <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> Checkout source code\n        <span class=\"token key atrule\">uses</span><span class=\"token punctuation\">:</span> actions/checkout@v3\n        \n    <span class=\"token comment\"># 해당 workflow를 python3.8 환경에서 실행하겠다고 명시</span>\n    <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> Setup python\n        <span class=\"token key atrule\">uses</span><span class=\"token punctuation\">:</span> actions/setup<span class=\"token punctuation\">-</span>python@v3\n        <span class=\"token key atrule\">with</span><span class=\"token punctuation\">:</span>\n        <span class=\"token key atrule\">python-version</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"3.8\"</span>\n    \n    <span class=\"token comment\"># 리눅스 환경에 docker를 세팅하는 shell script를 실행</span>\n    <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> Setup Docker\n        <span class=\"token key atrule\">run</span><span class=\"token punctuation\">:</span> sh scripts/setup<span class=\"token punctuation\">-</span>docker.sh\n\n    <span class=\"token comment\"># ${{ secrets.* }} 변수를 사용하여 Settings > Secrets > Actions에 정의한 값을 가져오고</span>\n    <span class=\"token comment\"># .env파일을 생성하여 dev환경의 환경변수를 관리</span>\n    <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> Create env file\n        <span class=\"token key atrule\">run</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">|</span><span class=\"token scalar string\">\n        touch ${{ secrets.ENV_PATH }}\n        {\n            echo SECRET_KEY=\"\\\"${{ secrets.SECRET_KEY }}\"\\\"\n            echo RUN_ENV=\"\\\"${{ secrets.RUN_ENV }}\"\\\"\n            echo DOMAIN=\"\\\"${{ secrets.DOMAIN }}\"\\\"\n            echo PROD_ALLOWED_HOSTS='${{ secrets.PROD_ALLOWED_HOSTS }}'\n            echo CORS_ORIGIN_WHITELIST='${{ secrets.CORS_ORIGIN_WHITELIST }}'\n            ...\n        } >> ${{ secrets.ENV_PATH }}</span>\n    \n    <span class=\"token comment\"># containter를 빌드하고 배포하는 shell script를 수행</span>\n    <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> Build Docker containers\n        <span class=\"token key atrule\">run</span><span class=\"token punctuation\">:</span> sudo kill `sudo lsof <span class=\"token punctuation\">-</span>t <span class=\"token punctuation\">-</span>i<span class=\"token punctuation\">:</span>8084` <span class=\"token important\">&amp;&amp;</span> sh scripts/build<span class=\"token punctuation\">-</span>docker<span class=\"token punctuation\">-</span>compose.sh\n\n    <span class=\"token comment\"># container의 동작 상태를 확인한 뒤 job을 종료</span>\n    <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> Check container running state\n        <span class=\"token key atrule\">run</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">|</span><span class=\"token scalar string\">\n        if [ $(docker ps --format \"{{.Names}} {{.Status}}\" | grep \"Up\" | wc -l) -ne 3 ]\n        then\n            echo \"Build error while running docker-compose\"\n            exit 1\n        else\n            echo \"Deploy Complete\"\n        fi</span></code></pre></div>\n</li>\n<li>\n<p><code class=\"language-text\">schedule-deploy.yml</code></p>\n<ul>\n<li>production 서버에 동작하던 컨테이너를 중지 / dangling image를 삭제하여 서버 공간을 확보하는 동작을 별도의 shell script로 작성하여 workflow의 step에서 실행</li>\n<li>production 서버에 새로운 container들을 빌드 및 배포한뒤 동작 상태를 확인</li>\n<li>정상적으로 동작하지 않는 경우, 이전 버전의 release로 rollback</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\"><span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> Schedule Deployment\n<span class=\"token key atrule\">on</span><span class=\"token punctuation\">:</span>     <span class=\"token comment\"># main branch를 target으로 하는 pull request가 closed되었을 경우에만 동작하는 workflow</span>\n<span class=\"token key atrule\">pull_request</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">branches</span><span class=\"token punctuation\">:</span>\n    <span class=\"token punctuation\">-</span> main\n    <span class=\"token key atrule\">types</span><span class=\"token punctuation\">:</span>\n    <span class=\"token punctuation\">-</span> closed\n<span class=\"token key atrule\">jobs</span><span class=\"token punctuation\">:</span>\n<span class=\"token key atrule\">checkout</span><span class=\"token punctuation\">:</span>\n    <span class=\"token comment\"># 프로젝트를 build할 machine(runner)를 명시</span>\n    <span class=\"token key atrule\">runs-on</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span> self<span class=\"token punctuation\">-</span>hosted<span class=\"token punctuation\">,</span> label<span class=\"token punctuation\">-</span>go <span class=\"token punctuation\">]</span>\n    <span class=\"token comment\"># pull request가 merge된 경우에만 checkout job을 수행</span>\n    <span class=\"token key atrule\">if</span><span class=\"token punctuation\">:</span> $<span class=\"token punctuation\">{</span><span class=\"token punctuation\">{</span> github.event.pull_request.merged == true <span class=\"token punctuation\">}</span><span class=\"token punctuation\">}</span>\n    <span class=\"token key atrule\">steps</span><span class=\"token punctuation\">:</span>\n    <span class=\"token comment\"># runner가 workflow를 수행할 수 있도록 workspace에 permission 부여</span>\n    <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> Set Permissions\n        <span class=\"token key atrule\">run</span><span class=\"token punctuation\">:</span> sudo chown <span class=\"token punctuation\">-</span>R $USER<span class=\"token punctuation\">:</span>$USER $<span class=\"token punctuation\">{</span><span class=\"token punctuation\">{</span> github.workspace <span class=\"token punctuation\">}</span><span class=\"token punctuation\">}</span>\n\n    <span class=\"token comment\"># 프로젝트 소스코드를 리눅스 환경에 checkout하고 실행하도록 명시</span>\n    <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> Checkout source code\n        <span class=\"token key atrule\">uses</span><span class=\"token punctuation\">:</span> actions/checkout@v3\n        \n    <span class=\"token comment\"># 해당 workflow를 python3.8 환경에서 실행하겠다고 명시</span>\n    <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> Setup python\n        <span class=\"token key atrule\">uses</span><span class=\"token punctuation\">:</span> actions/setup<span class=\"token punctuation\">-</span>python@v3\n        <span class=\"token key atrule\">with</span><span class=\"token punctuation\">:</span>\n        <span class=\"token key atrule\">python-version</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"3.8\"</span>\n\n    <span class=\"token comment\"># 리눅스 환경에 docker를 세팅하는 shell script를 실행</span>\n    <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> Setup Docker\n        <span class=\"token key atrule\">run</span><span class=\"token punctuation\">:</span> sh scripts/setup<span class=\"token punctuation\">-</span>docker.sh\n\n<span class=\"token key atrule\">deploy</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">runs-on</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span> self<span class=\"token punctuation\">-</span>hosted<span class=\"token punctuation\">,</span> label<span class=\"token punctuation\">-</span>go <span class=\"token punctuation\">]</span>\n    <span class=\"token comment\"># checkout job이 완료되었을 경우 동작하도록 의존관계를 설정 </span>\n    <span class=\"token key atrule\">needs</span><span class=\"token punctuation\">:</span> checkout\n    <span class=\"token key atrule\">if</span><span class=\"token punctuation\">:</span> $<span class=\"token punctuation\">{</span><span class=\"token punctuation\">{</span> github.event.pull_request.merged == true <span class=\"token punctuation\">}</span><span class=\"token punctuation\">}</span>\n    <span class=\"token key atrule\">steps</span><span class=\"token punctuation\">:</span>\n    <span class=\"token comment\"># ${{ secrets.* }} 변수를 사용하여 Settings > Secrets > Actions에 정의한 값을 가져오고</span>\n    <span class=\"token comment\"># .env파일을 생성하여 dev환경의 환경변수를 관리</span>\n    <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> Create env file\n        <span class=\"token key atrule\">run</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">|</span><span class=\"token scalar string\">\n        touch ${{ secrets.ENV_PATH }}\n        {\n            echo SECRET_KEY=\"\\\"${{ secrets.SECRET_KEY }}\"\\\"\n            echo RUN_ENV=\"\\\"${{ secrets.RUN_ENV }}\"\\\"\n            echo DOMAIN=\"\\\"${{ secrets.DOMAIN }}\"\\\"\n            echo PROD_ALLOWED_HOSTS='${{ secrets.PROD_ALLOWED_HOSTS }}'\n            echo CORS_ORIGIN_WHITELIST='${{ secrets.CORS_ORIGIN_WHITELIST }}'\n            ...\n        } >> ${{ secrets.ENV_PATH }}</span>\n\n    <span class=\"token comment\"># container를 빌드하고 배포하는 shell script를 수행</span>\n    <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> Build Docker containers\n        <span class=\"token key atrule\">run</span><span class=\"token punctuation\">:</span> sh scripts/build<span class=\"token punctuation\">-</span>docker<span class=\"token punctuation\">-</span>compose.sh\n\n    <span class=\"token comment\"># container의 동작 상태를 확인한 뒤 job을 종료</span>\n    <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> Check container running state\n        <span class=\"token key atrule\">run</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">|</span><span class=\"token scalar string\">\n        if [ $(docker ps --format \"{{.Names}} {{.Status}}\" | grep \"Up\" | wc -l) -ne 3 ]\n        then\n            echo \"Build error while running docker-compose\"\n            exit 1\n        else\n            echo \"Deploy Complete\"\n        fi</span>\n\n<span class=\"token key atrule\">rollback</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">runs-on</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span> self<span class=\"token punctuation\">-</span>hosted<span class=\"token punctuation\">,</span> label<span class=\"token punctuation\">-</span>go <span class=\"token punctuation\">]</span>\n    <span class=\"token comment\"># checkout, deploy job이 모두 완료되었을 경우 동작하도록 의존관계를 설정 </span>\n    <span class=\"token key atrule\">needs</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span> checkout<span class=\"token punctuation\">,</span> deploy <span class=\"token punctuation\">]</span>\n    <span class=\"token comment\"># 의존관계가 설정되어 있는 job들 중 하나라도 실패하였을 경우 동작하도록 조건 설정</span>\n    <span class=\"token key atrule\">if</span><span class=\"token punctuation\">:</span> $<span class=\"token punctuation\">{</span><span class=\"token punctuation\">{</span> always() <span class=\"token important\">&amp;&amp;</span> contains(needs.<span class=\"token important\">*.result</span><span class=\"token punctuation\">,</span> 'failure') <span class=\"token punctuation\">}</span><span class=\"token punctuation\">}</span>\n    <span class=\"token key atrule\">steps</span><span class=\"token punctuation\">:</span>\n    <span class=\"token comment\"># runner가 workflow를 수행할 수 있도록 workspace에 permission 부여</span>\n    <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> Set Action Runner Permissions\n        <span class=\"token key atrule\">run</span><span class=\"token punctuation\">:</span> sudo chown <span class=\"token punctuation\">-</span>R $USER<span class=\"token punctuation\">:</span>$USER $<span class=\"token punctuation\">{</span><span class=\"token punctuation\">{</span> github.workspace <span class=\"token punctuation\">}</span><span class=\"token punctuation\">}</span>\n\n    <span class=\"token comment\"># rollback job을 수행하기 위하여 마지막으로 release된 버전의 소스코드를 fetch</span>\n    <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> Fetch Latest Release\n        <span class=\"token key atrule\">id</span><span class=\"token punctuation\">:</span> fetch<span class=\"token punctuation\">-</span>latest\n        <span class=\"token key atrule\">uses</span><span class=\"token punctuation\">:</span> thebritican/fetch<span class=\"token punctuation\">-</span>latest<span class=\"token punctuation\">-</span>release@v1.0.3\n        <span class=\"token key atrule\">with</span><span class=\"token punctuation\">:</span>\n        <span class=\"token key atrule\">github_token</span><span class=\"token punctuation\">:</span> $<span class=\"token punctuation\">{</span><span class=\"token punctuation\">{</span> secrets.GITHUB_TOKEN <span class=\"token punctuation\">}</span><span class=\"token punctuation\">}</span>\n\n    <span class=\"token comment\"># fetch-latest step에서 fetch한 버전의 소스코드로 checkout</span>\n    <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> Checkout Latest Release source code\n        <span class=\"token key atrule\">uses</span><span class=\"token punctuation\">:</span> actions/checkout@v3\n        <span class=\"token key atrule\">with</span><span class=\"token punctuation\">:</span>\n        <span class=\"token key atrule\">ref</span><span class=\"token punctuation\">:</span> $<span class=\"token punctuation\">{</span><span class=\"token punctuation\">{</span> steps.fetch<span class=\"token punctuation\">-</span>latest.outputs.tag_name <span class=\"token punctuation\">}</span><span class=\"token punctuation\">}</span>\n\n    <span class=\"token comment\"># container를 빌드하고 배포하는 shell script를 수행</span>\n    <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> Build Docker containers\n        <span class=\"token key atrule\">run</span><span class=\"token punctuation\">:</span> sh scripts/build<span class=\"token punctuation\">-</span>docker<span class=\"token punctuation\">-</span>compose.sh\n\n    <span class=\"token comment\"># container의 동작 상태를 확인한 뒤 job을 종료</span>\n    <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> Check container running state\n        <span class=\"token key atrule\">run</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">|</span><span class=\"token scalar string\">\n        if [ $(docker ps --format \"{{.Names}} {{.Status}}\" | grep \"Up\" | wc -l) -ne 3 ]\n        then\n            echo \"Build error while running docker-compose\"\n            exit 1\n        else\n            echo \"Deploy Complete\"\n        fi</span></code></pre></div>\n</li>\n<li>\n<p><code class=\"language-text\">auto-release.yml</code></p>\n<ul>\n<li>pull request를 활용한 소스코드 release, tag 생성 및 관리 자동화</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\"><span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> Auto Release\n<span class=\"token key atrule\">on</span><span class=\"token punctuation\">:</span>  <span class=\"token comment\"># pull request가 opened / reopened / synchronize / edited / closed되었을 때 동작하는 workflow</span>\n<span class=\"token key atrule\">pull_request</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">types</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span>opened<span class=\"token punctuation\">,</span> reopened<span class=\"token punctuation\">,</span> synchronize<span class=\"token punctuation\">,</span> edited<span class=\"token punctuation\">,</span> closed<span class=\"token punctuation\">]</span>\n\n<span class=\"token key atrule\">jobs</span><span class=\"token punctuation\">:</span>\n<span class=\"token key atrule\">release</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">runs-on</span><span class=\"token punctuation\">:</span> ubuntu<span class=\"token punctuation\">-</span>latest\n    <span class=\"token comment\"># pull request가 target으로 하는 branch가 main일 경우에만 수행되도록 조건을 설정</span>\n    <span class=\"token key atrule\">if</span><span class=\"token punctuation\">:</span> $<span class=\"token punctuation\">{</span><span class=\"token punctuation\">{</span> contains(github.base_ref<span class=\"token punctuation\">,</span> 'main') <span class=\"token punctuation\">|</span><span class=\"token punctuation\">|</span> contains(github.ref<span class=\"token punctuation\">,</span> 'main') <span class=\"token punctuation\">}</span><span class=\"token punctuation\">}</span>\n    <span class=\"token key atrule\">steps</span><span class=\"token punctuation\">:</span>\n    <span class=\"token comment\"># workflow를 실행하기 위해 필요한 코드에 대해서만 sparse checkout 수행</span>\n    <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> Sparse<span class=\"token punctuation\">-</span>checkout\n        <span class=\"token key atrule\">uses</span><span class=\"token punctuation\">:</span> lablup/sparse<span class=\"token punctuation\">-</span>checkout@v1\n        <span class=\"token key atrule\">with</span><span class=\"token punctuation\">:</span>\n        <span class=\"token key atrule\">patterns</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">|</span><span class=\"token scalar string\">\n            scripts</span>\n    <span class=\"token comment\"># release할 version명을 output으로 저장하는 step 수행</span>\n    <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> Extract version\n        <span class=\"token key atrule\">id</span><span class=\"token punctuation\">:</span> extract<span class=\"token punctuation\">-</span>version\n        <span class=\"token key atrule\">run</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">|</span><span class=\"token scalar string\">\n        # release명은 pull request의 title에 명시된 '숫자.숫자.숫자' 포맷으로 설정\n        # 해당 규칙을 준수한 release명이 존재하지 않거나, 잘못된 값이 입력되어 있는 경우에는 이후의 step을 모두 skip\n        version=$(echo '${{ github.event.pull_request.title }}' | egrep -o '[0-9]{1,3}\\.[0-9]{1,3}\\.[0-9]{1,3}')\n        echo \"::set-output name=version::$version\"</span>\n\n    <span class=\"token comment\"># 현재 branch와 이전 버전 release 사이의 commit log들을 CHANGELOG_RELEASE.md에 저장하고</span>\n    <span class=\"token comment\"># 존재하던 CHANGELOG.md를 업데이트하는 python script를 실행</span>\n    <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> Auto Generate Changelog\n        <span class=\"token key atrule\">id</span><span class=\"token punctuation\">:</span> changelog\n        <span class=\"token key atrule\">if</span><span class=\"token punctuation\">:</span> $<span class=\"token punctuation\">{</span><span class=\"token punctuation\">{</span> steps.extract<span class=\"token punctuation\">-</span>version.outputs.version <span class=\"token punctuation\">}</span><span class=\"token punctuation\">}</span>\n        <span class=\"token key atrule\">run</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">|</span><span class=\"token scalar string\">\n        python3 ./scripts/generate_changelog.py --version \"${{ steps.extract-version.outputs.version }}\" --tag \"${{ github.head_ref }}\"</span>\n\n    <span class=\"token comment\"># CHANGELOG_RELEASE.md에 변경내용이 존재하는지, 즉 새로운 버전의 release를 생성할 필요가 있는지 확인</span>\n    <span class=\"token comment\"># 해당 workflow에서 설정한 github action(pull request)가 close되고,</span>\n    <span class=\"token comment\"># extract-version step에서 올바른 형태의 버전명을 얻어낸 경우에만 수행하도록 조건을 설정</span>\n    <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> Get Changed Files\n        <span class=\"token key atrule\">id</span><span class=\"token punctuation\">:</span> changed<span class=\"token punctuation\">-</span>files\n        <span class=\"token key atrule\">if</span><span class=\"token punctuation\">:</span> $<span class=\"token punctuation\">{</span><span class=\"token punctuation\">{</span> github.event.action <span class=\"token tag\">!=</span> 'closed' <span class=\"token important\">&amp;&amp;</span> steps.extract<span class=\"token punctuation\">-</span>version.outputs.version <span class=\"token punctuation\">}</span><span class=\"token punctuation\">}</span>\n        <span class=\"token key atrule\">uses</span><span class=\"token punctuation\">:</span> tj<span class=\"token punctuation\">-</span>actions/changed<span class=\"token punctuation\">-</span>files@v31\n\n    <span class=\"token comment\"># 이전 step인 changed-files에서 변경된 파일이 있는 경우, 파일을 staged 상태로 전환한뒤 자동으로 커밋</span>\n    <span class=\"token comment\"># 이 때, 커밋할 파일(CHANGELOG.md)과 커밋 메세지는 with 구문을 사용하여 지정 </span>\n    <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> Auto Commit Updated Changelog\n        <span class=\"token key atrule\">id</span><span class=\"token punctuation\">:</span> auto<span class=\"token punctuation\">-</span>commit<span class=\"token punctuation\">-</span>push\n        <span class=\"token key atrule\">if</span><span class=\"token punctuation\">:</span> $<span class=\"token punctuation\">{</span><span class=\"token punctuation\">{</span> github.event.action <span class=\"token tag\">!=</span> 'closed' <span class=\"token important\">&amp;&amp;</span> steps.changed<span class=\"token punctuation\">-</span>files.outputs.any_changed == true <span class=\"token important\">&amp;&amp;</span> steps.extract<span class=\"token punctuation\">-</span>version.outputs.version <span class=\"token punctuation\">}</span><span class=\"token punctuation\">}</span>\n        <span class=\"token key atrule\">uses</span><span class=\"token punctuation\">:</span> stefanzweifel/git<span class=\"token punctuation\">-</span>auto<span class=\"token punctuation\">-</span>commit<span class=\"token punctuation\">-</span>action@v4\n        <span class=\"token key atrule\">with</span><span class=\"token punctuation\">:</span>\n        <span class=\"token key atrule\">commit_message</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"update: CHANGELOG.md\"</span>\n        <span class=\"token key atrule\">file_pattern</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"CHANGELOG.md\"</span>\n\n    <span class=\"token comment\"># 조건을 만족하는 경우, 새로운 버전의 release와 tag를 생성</span>\n    <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> Create Release with Tag\n        <span class=\"token key atrule\">if</span><span class=\"token punctuation\">:</span> $<span class=\"token punctuation\">{</span><span class=\"token punctuation\">{</span> github.event.action == 'closed' <span class=\"token important\">&amp;&amp;</span> github.event.pull_request.merged == true <span class=\"token important\">&amp;&amp;</span> steps.extract<span class=\"token punctuation\">-</span>version.outputs.version == true <span class=\"token important\">&amp;&amp;</span> contains(github.event.pull_request.title<span class=\"token punctuation\">,</span> 'release') <span class=\"token punctuation\">}</span><span class=\"token punctuation\">}</span>\n        <span class=\"token key atrule\">uses</span><span class=\"token punctuation\">:</span> ncipollo/release<span class=\"token punctuation\">-</span>action@v1\n        <span class=\"token key atrule\">with</span><span class=\"token punctuation\">:</span>\n        <span class=\"token key atrule\">tag</span><span class=\"token punctuation\">:</span> $<span class=\"token punctuation\">{</span><span class=\"token punctuation\">{</span> steps.extract<span class=\"token punctuation\">-</span>version.outputs.version <span class=\"token punctuation\">}</span><span class=\"token punctuation\">}</span>\n        <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> $<span class=\"token punctuation\">{</span><span class=\"token punctuation\">{</span> steps.extract<span class=\"token punctuation\">-</span>version.outputs.version <span class=\"token punctuation\">}</span><span class=\"token punctuation\">}</span>\n        <span class=\"token key atrule\">bodyFile</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"./CHANGELOG_RELEASE.md\"</span>\n        <span class=\"token key atrule\">skipIfReleaseExists</span><span class=\"token punctuation\">:</span> <span class=\"token boolean important\">true</span></code></pre></div>\n</li>\n</ol>\n<br>\n<h2 id=\"마무리\" style=\"position:relative;\"><a href=\"#%EB%A7%88%EB%AC%B4%EB%A6%AC\" aria-label=\"마무리 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>마무리</h2>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 720px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 51.11111111111111%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAKCAYAAAC0VX7mAAAACXBIWXMAAAsTAAALEwEAmpwYAAABYElEQVQoz4WS63KCMBCFqSi3ACGSgIDlXnHs6Pu/3Wl3FarWTn+cOSGz+7GXWPnYYzheMEwX1P0RZT2iag/YdxO7LhpEKn+pMMlgihbNcELZfECZCpZpGrz3E/KqW2BFPSLfd9C7GokuEMQaQhoIqVn8HZOnDKE8UzSQaQFLZzXSvOagILoGe+EWUaKxbwY4fgTbCWDZLmvlBFBZxQpVBpEYOEJyjCcSWPX5jO7wiaxsYcqGnf7kBhIy3SGIthz8tvZu8mE74qZg8RUDFaxqmtCOJ8TbHaQuGEbz2XgRlKGzgRvEXB0DbW+p9l6rjQ8vVLCyouXB0ozmQZM2PgFLxCpDKDU2XvgDfRLdc8sEpG3SlmbY7FQhLSRKzBW2ch4Az8ClQtpSvu+51QcgVUhAGnyccsIr2C8gJVO797D7lmmGQqbwQ8VJfwGXlp8f6gxeuyE8IeEKeQX90zK5+/1svgCkAem80os1pQAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"cicd-005.png\"\n        title=\"cicd-005.png\"\n        src=\"/static/455b5059cc40b360be2fa353138286b2/37523/cicd-005.png\"\n        srcset=\"/static/455b5059cc40b360be2fa353138286b2/e9ff0/cicd-005.png 180w,\n/static/455b5059cc40b360be2fa353138286b2/f21e7/cicd-005.png 360w,\n/static/455b5059cc40b360be2fa353138286b2/37523/cicd-005.png 720w,\n/static/455b5059cc40b360be2fa353138286b2/a0b80/cicd-005.png 955w\"\n        sizes=\"(max-width: 720px) 100vw, 720px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n    </span><em>workflow 수행결과</em></p>\n<p>이렇게 <code class=\"language-text\">Github Action</code>을 사용하여 빌드 및 배포뿐만 아니라 버전관리까지 자동화할 수 있었다.\n<code class=\"language-text\">YAML</code> 문법을 사용하여 workflow를 작성할 수 있고 github 공식 도큐먼트가 매우 잘 정리되어 있어서 활용이 매우 편리했다.\n다음에는 자동화하고 싶은 action을 직접 github marketplace에 배포해보는 것이 목표다!</p>\n<br>\n<div class=\"table-of-contents\">\n<ul>\n<li><a href=\"#cicd-%ED%94%84%EB%A1%9C%EC%84%B8%EC%8A%A4-%EC%84%A4%EA%B3%84%ED%95%B4%EB%B3%B4%EA%B8%B0\">CI/CD 프로세스 설계해보기</a></li>\n<li><a href=\"#github%EB%A5%BC-%ED%99%9C%EC%9A%A9%ED%95%9C-cicd-%ED%99%98%EA%B2%BD-%EA%B4%80%EB%A6%AC\">Github를 활용한 CI/CD 환경 관리</a></li>\n<li><a href=\"#workflow-%EA%B5%AC%ED%98%84%ED%95%98%EA%B8%B0\">Workflow 구현하기</a></li>\n<li><a href=\"#%EB%A7%88%EB%AC%B4%EB%A6%AC\">마무리</a></li>\n</ul>\n</div>","frontmatter":{"date":"December 16, 2022","title":"Github Action으로 EC2에서 배포 자동화하기","categories":"DevOps ci/cd Github","author":"소희","emoji":"🗣"},"fields":{"slug":"/github/ci-cd/"}},"prev":{"id":"9c38cc4c-2b93-5988-9a44-96136daea0e6","html":"<h2 id=\"비동기-프로그래밍과-동작원리\" style=\"position:relative;\"><a href=\"#%EB%B9%84%EB%8F%99%EA%B8%B0-%ED%94%84%EB%A1%9C%EA%B7%B8%EB%9E%98%EB%B0%8D%EA%B3%BC-%EB%8F%99%EC%9E%91%EC%9B%90%EB%A6%AC\" aria-label=\"비동기 프로그래밍과 동작원리 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>비동기 프로그래밍과 동작원리</h2>\n<p><strong>비동기(asynchronous)</strong> 처리는 현재 실행 중인 작업이 완료되지 않은 상태에서 다른 작업을 처리하도록 요청할 수 있는 방식이다. <strong>동기(synchronous)</strong> 처리와 다르게 여러 작업을 동시에 실행할 수 있다는 장점이 있다.</p>\n<p>파이선에서는 비동기 프로그래밍을 적용하여 동시성을 보장하기 위해 <code class=\"language-text\">asyncio</code>라는 모듈을 사용한다.</p>\n<br>\n<h2 id=\"coroutine코루틴\" style=\"position:relative;\"><a href=\"#coroutine%EC%BD%94%EB%A3%A8%ED%8B%B4\" aria-label=\"coroutine코루틴 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Coroutine(코루틴)</h2>\n<p>특정 함수를 실행할 때, 반복되는 작업을 개별 함수로 분리하고 이를 호출하여 사용할 수 있다. 여기서 호출되어 수행되는 흐름을 <code class=\"language-text\">Sub Routine</code>이라고 한다. <code class=\"language-text\">Sub Routine</code>은 하나의 entry point를 가지고 있으며 호출되는 <code class=\"language-text\">Main Routine</code>에 종속적이라는 특징을 가지고 있다.</p>\n<p><code class=\"language-text\">Coroutine</code>이란 서브 루틴처럼 특정 함수의 실행에 종속되어 있는 것이 아닌, 대등한 관계를 가지고 서로 순차적으로 호출할 수 있도록 구현된 함수라고 할 수 있다. <code class=\"language-text\">Sub Routine</code>과 달리 여러 개의 entry point와 exit point를 가진다.\n<code class=\"language-text\">Coroutine</code>을 이해하기 위해 아래 개념들을 알 필요가 있다.</p>\n<br>\n<h3 id=\"iterator이터레이터\" style=\"position:relative;\"><a href=\"#iterator%EC%9D%B4%ED%84%B0%EB%A0%88%EC%9D%B4%ED%84%B0\" aria-label=\"iterator이터레이터 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Iterator(이터레이터)</h3>\n<p>순서대로 값을 리턴할 수 있는 객체이다. 필요한 값을 메모리에 할당하고, 반환하도록 동작하여 메모리를 효율적으로 사용할 수 있다. <code class=\"language-text\">iter(object)</code> 또는 <code class=\"language-text\">object.__iter__()</code>를 사용하여 정의할 수 있고, <code class=\"language-text\">object.__next__()</code> 메소드를 호출하여 객체를 호출될 때마다 다음 값을 리턴하게 구현할 수 있다. 또한 특정 object에 <code class=\"language-text\">iter()</code>함수를 사용할 때마다 새로운 <code class=\"language-text\">Iterator</code> 객체가 생성되고, 각각의 객체들은 서로 독립적인 상태를 가지게 된다.<br>\n이러한 특성을 활용하여 <b>필요한 시점에 객체를 호출하여 여러 작업을 번갈아가면서 수행</b>하도록 구현할 수 있다.\n가장 간단하게 for문으로 수행하는 파이선의 <code class=\"language-text\">range()</code> 함수를 예로 들 수 있다. iteratable한 객체, 즉 반복이 가능한 객체를 메모리에 할당하지 않고 순차적으로 사용할 수 있다.</p>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\"><span class=\"token comment\"># 0 ~ 99의 integer를 별도의 메모리 공간에 할당해두지 않고, iteration이 될 때마다 꺼내어서 사용</span>\n<span class=\"token keyword\">for</span> i <span class=\"token keyword\">in</span> <span class=\"token builtin\">range</span><span class=\"token punctuation\">(</span><span class=\"token number\">100</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span> \n    <span class=\"token builtin\">sum</span> <span class=\"token operator\">+=</span> i</code></pre></div>\n<br>\n<h3 id=\"generator제너레이터\" style=\"position:relative;\"><a href=\"#generator%EC%A0%9C%EB%84%88%EB%A0%88%EC%9D%B4%ED%84%B0\" aria-label=\"generator제너레이터 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Generator(제너레이터)</h3>\n<p><code class=\"language-text\">__iter__()</code>를 사용하지 않고도 <code class=\"language-text\">Iterator</code> 객체를 생성할 수 있다. 가장 큰 차이는 <code class=\"language-text\">yield</code>를 사용하여 중단점을 설정하고 작업을 재개할 수 있도록 구현되었다는 점이다. <code class=\"language-text\">generator</code> 객체를 생성한 뒤 <code class=\"language-text\">next(object)</code>를 호출해야 작업이 시작되며, 실행 시마다 값을 메모리에 할당하여 사용한다.</p>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\"><span class=\"token keyword\">def</span> <span class=\"token function\">generator</span><span class=\"token punctuation\">(</span>nums<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n    <span class=\"token keyword\">for</span> i <span class=\"token keyword\">in</span> nums<span class=\"token punctuation\">:</span>\n        <span class=\"token keyword\">yield</span> i</code></pre></div>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">print<span class=\"token punctuation\">(</span>generator<span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span><span class=\"token number\">1</span>, <span class=\"token number\">2</span>, <span class=\"token number\">3</span>, <span class=\"token number\">4</span>, <span class=\"token number\">5</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">))</span>       <span class=\"token comment\"># 값들이 메모리에 적재되어 있지 않고, 객체만 생성된 상태</span>\n<span class=\"token operator\">>></span> <span class=\"token operator\">&lt;</span>generator object generator at 0x00E3556<span class=\"token operator\"><span class=\"token file-descriptor important\">8</span>></span></code></pre></div>\n<br>\n<p><code class=\"language-text\">generator</code>를 호출하는 함수를 <code class=\"language-text\">caller</code>라고 하자.\n<code class=\"language-text\">caller</code>에서 <code class=\"language-text\">next(object)</code>를 호출하면 제어권이 <code class=\"language-text\">generator</code>로 전달되고, 로직에 따라 작업을 수행한다. <code class=\"language-text\">yield</code> 구문을 만나면, 실행 결과를 저장하고 다시 caller쪽으로 제어권을 반환한다. <code class=\"language-text\">caller</code>가 <code class=\"language-text\">generator</code>로 값을 전달할 때는 <code class=\"language-text\">object.send(value)</code> 함수를 사용하면 된다. (아직 시작이 되지 않은 generator에는 <code class=\"language-text\">None</code>값만 전달할 수 있다.</p>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\"><span class=\"token keyword\">def</span> <span class=\"token function\">generator_coroutine</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n    <span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span><span class=\"token string\">'callee 1'</span><span class=\"token punctuation\">)</span>\n    x <span class=\"token operator\">=</span> <span class=\"token keyword\">yield</span> <span class=\"token number\">1</span>\n    <span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span><span class=\"token string\">'callee 2: %d'</span> <span class=\"token operator\">%</span> x<span class=\"token punctuation\">)</span>\n    x <span class=\"token operator\">=</span> <span class=\"token keyword\">yield</span> <span class=\"token number\">2</span>\n\t\ntask <span class=\"token operator\">=</span> generator_coroutine<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\ni <span class=\"token operator\">=</span> <span class=\"token builtin\">next</span><span class=\"token punctuation\">(</span>task<span class=\"token punctuation\">)</span>    <span class=\"token comment\"># i = 1 / caller 1 출력</span>\ni <span class=\"token operator\">=</span> task<span class=\"token punctuation\">.</span>send<span class=\"token punctuation\">(</span><span class=\"token number\">10</span><span class=\"token punctuation\">)</span> <span class=\"token comment\"># i = 2 / caller 2: 10 출력</span></code></pre></div>\n<br>\n<p>두 개 이상의 <code class=\"language-text\">Generator</code>가 서로 값을 주고받으면서 교차적으로 수행할 수 있어서 <code class=\"language-text\">lightweight coroutine</code>이라고 표현하기도 한다. 하나의 thread 위에서 여러 실행 흐름이 존재할 수 있도록 구현함으로서 작업들이 동시에 진행되는 것처럼 처리할 수 있다.</p>\n<p><code class=\"language-text\">yield from</code> 구문을 사용하여 <code class=\"language-text\">Coroutine</code> 내부에서 <code class=\"language-text\">Sub Coroutine</code>을 사용하도록 구현할 수도 있다.</p>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\"><span class=\"token keyword\">def</span> <span class=\"token function\">generator</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n\t<span class=\"token keyword\">yield</span> <span class=\"token keyword\">from</span> generator_2<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n\t<span class=\"token keyword\">yield</span> <span class=\"token keyword\">from</span> generator_3<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></code></pre></div>\n<br>\n<blockquote>\n<p><strong><em>NOTE:</em></strong> 파이선에서는 <code class=\"language-text\">yield</code>를 사용하는 <code class=\"language-text\">coroutine</code>을 <code class=\"language-text\">Generator-based coroutine</code>이라고 부르고, <code class=\"language-text\">asyncio</code> 모듈에서 지원하는 <code class=\"language-text\">async/await</code> 키워드를 사용하여 <code class=\"language-text\">coroutine</code>을 정의하는 방식을 <code class=\"language-text\">Native coroutine</code>이라고 부른다.</p>\n</blockquote>\n<br>\n<h2 id=\"event-loop\" style=\"position:relative;\"><a href=\"#event-loop\" aria-label=\"event loop permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Event Loop</h2>\n<p>파이선 <code class=\"language-text\">asyncio</code>에서는 <code class=\"language-text\">coroutine</code>과 <code class=\"language-text\">event loop</code>를 사용하여 비동기 프로그래밍을 지원한다.</p>\n<p><code class=\"language-text\">coroutine</code> 객체가 생성 및 반환 후에 <code class=\"language-text\">coroutine</code>을 실행해주는 부분이 선언되어 있어야 작업(task)이 개시된다. 여기서 사용되는 개념이 바로 event loop이다. event loop는 하나의 thread에서 등록된 여러 코루틴 사이의 실행권을 가지고 연산을 수행시키는 역할을 한다.\n쉽개 말하면, 무한히 loop를 돌며, loop마다 작업(task)을 하나씩 실행시키는 일종의 로직이다. thread에 event loop를 설정한다는 것은 **“작업, 즉 하나의 coroutine에서 출발하는 하나의 실행 흐름을 수행할 수 로직을 실행할 객체를 생성한 것”**이라고 이해하면 된다.</p>\n<p>이 때 전달받은 <code class=\"language-text\">coroutine</code> 객체는 <code class=\"language-text\">async def</code>를 사용하여 정의된 함수여야 한다.</p>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\"><span class=\"token keyword\">async</span> <span class=\"token keyword\">def</span> <span class=\"token function\">coroutine</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n    <span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span><span class=\"token string\">'coroutine'</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">await</span> asyncio<span class=\"token punctuation\">.</span>sleep<span class=\"token punctuation\">(</span><span class=\"token number\">0.1</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">return</span> <span class=\"token number\">1</span>\n\nloop <span class=\"token operator\">=</span> asyncio<span class=\"token punctuation\">.</span>get_event_loop<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n<span class=\"token comment\"># 더 이상 수행될 task가 없을때까지 무한히 loop를 돌며 전달받은 coroutine 객체를 처리</span>\nloop<span class=\"token punctuation\">.</span>run_until_complete<span class=\"token punctuation\">(</span>coroutine<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n<span class=\"token comment\"># event loop에 아직 실행이 종료되지 않은 task가 남아있다면, 모두 제거</span>\nloop<span class=\"token punctuation\">.</span>close<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></code></pre></div>\n<br>\n<h3 id=\"future퓨쳐와-task테스크\" style=\"position:relative;\"><a href=\"#future%ED%93%A8%EC%B3%90%EC%99%80-task%ED%85%8C%EC%8A%A4%ED%81%AC\" aria-label=\"future퓨쳐와 task테스크 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Future(퓨쳐)와 Task(테스크)</h3>\n<p><code class=\"language-text\">coroutine</code> 내부에서 다른 작업, 즉 <code class=\"language-text\">sub coroutine</code>을 수행하는 경우에는 <code class=\"language-text\">Future</code>, <code class=\"language-text\">Task</code>와 같은 <code class=\"language-text\">Awaitable</code>한 객체(실행을 종료할 때까지 기다릴 객체)를 <code class=\"language-text\">await</code>과 함께 사용해야 한다.</p>\n<p><code class=\"language-text\">Future</code>는 어떠한 작업의 실행 상태 및 결과를 저장하는 객체로, non-blocking 작업을 리턴한다고 볼 수 있다. <em>(작업의 실행을 시작하는 역할은 수행하지 않는다.)</em> <code class=\"language-text\">add_done_callback()</code>으로 완료 시에 호출할 콜백함수를 등록할 수 있고, <code class=\"language-text\">result()</code>로 실행결과를 반환한다.</p>\n<p><code class=\"language-text\">Task</code>는 <code class=\"language-text\">Future</code>를 상속한 객체로, 작업의 실행 상태 및 결과를 저장한다. <code class=\"language-text\">Future</code>와는 달리 작업의 실행을 개시하는 역할까지 수행한다. <code class=\"language-text\">asyncio.run()</code> 또는 <code class=\"language-text\">asyncio.create_task()</code>함수<text style=\"color:grey;\"> <em>(Python 3.6 이전에서는 <code class=\"language-text\">asyncio.ensure_future()</code>를 사용)</em> </text>를 호출할 때 <code class=\"language-text\">coroutine</code> 객체를 인자로 전달하면, <code class=\"language-text\">Task</code>객체가 생성되면서 전달받은 <code class=\"language-text\">coroutine</code>이 <code class=\"language-text\">Task</code>로 실행되도록 예약된다.</p>\n<br>\n<h2 id=\"event-loop가-coroutine을-실행하는-방식\" style=\"position:relative;\"><a href=\"#event-loop%EA%B0%80-coroutine%EC%9D%84-%EC%8B%A4%ED%96%89%ED%95%98%EB%8A%94-%EB%B0%A9%EC%8B%9D\" aria-label=\"event loop가 coroutine을 실행하는 방식 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Event Loop가 Coroutine을 실행하는 방식</h2>\n<p><code class=\"language-text\">coroutine</code> 객체의 생성 및 반환이 <code class=\"language-text\">coroutine</code>의 실행을 의미하지 않는다고 하였다. 아래는 <code class=\"language-text\">coroutine</code>을 실행하기 위한 방법들이다.</p>\n<p><strong>1. <code class=\"language-text\">await</code> syntax</strong></p>\n<p><code class=\"language-text\">coroutine</code> 내부에서만 사용할 수 있는 키워드이다. 따라서 <code class=\"language-text\">coroutine</code>을 처음 실행할 때는 사용할 수 없고, 다른 <code class=\"language-text\">coroutine</code> 내부에서 <code class=\"language-text\">sub coroutine</code>을 호출하는 경우에 사용할 수 있다. 다른 <code class=\"language-text\">coroutine</code>을 호출하고, 해당 작업이 완료될 때까지 기다린다. 또한 다른 <code class=\"language-text\">coroutine</code>에 대한 entry point라고도 이해할 수 있다.</p>\n<br>\n<p><strong>2. <code class=\"language-text\">asyncio.run()</code> 함수</strong></p>\n<p>    \n<strong>① 현재 실행 중인 thread에 새로운 event loop를 설정</strong>하고<br>\n    \n<strong>② 인자로 전달되는 <code class=\"language-text\">coroutine</code> 객체를 <code class=\"language-text\">task</code>로 예약하여 실행</strong>하고<br>\n    \n<strong>③<code class=\"language-text\">task</code>의 실행이 완료되면 event loop를 닫는 역할</strong>을 수행한다.</p>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\"><span class=\"token keyword\">async</span> <span class=\"token keyword\">def</span> <span class=\"token function\">function</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n    <span class=\"token keyword\">try</span><span class=\"token punctuation\">:</span>\n        loop <span class=\"token operator\">=</span> asyncio<span class=\"token punctuation\">.</span>get_running loop<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">except</span> RuntimeError<span class=\"token punctuation\">:</span>\n        loop <span class=\"token operator\">=</span> asyncio<span class=\"token punctuation\">.</span>new_event_loop<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">finally</span><span class=\"token punctuation\">:</span>\n        loop<span class=\"token punctuation\">.</span>run_until_complete<span class=\"token punctuation\">(</span>coroutine<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n        loop<span class=\"token punctuation\">.</span>close<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></code></pre></div>\n<blockquote>\n<p><strong><em>NOTE:</em></strong> <code class=\"language-text\">get_event_loop()</code>는 실행 중인 event loop를 가져오기 위해 사용하는 함수로, 실행 중인 event loop가 없는 경우, <code class=\"language-text\">RuntimeError</code>를 발생시킨다. Python 3.10 이상에서는 지원되지 않는 함수로, coroutine이나 callback에서는 <code class=\"language-text\">get_running_loop()</code>를 사용하는 것이 권장된다.</p>\n</blockquote>\n<br>\n<p><strong>3. <code class=\"language-text\">asyncio.create_task()</code>와 <code class=\"language-text\">asyncio.gather()</code> 함수</strong></p>\n<p><code class=\"language-text\">asyncio.run()</code>은 기본적으로 하나의 task를 실행한다. 따라서 여러 <code class=\"language-text\">Task</code>객체를 생성하여 실행하는 경우에만 동시적(concurrent)성이 보장된다고 할 수 있다.\n전달받은 여러 Awaitable 객체들이 완료될 때까지 기다렸다가, 그 완료 결과를 리스트 형태로 반환하는 함수가 바로 <code class=\"language-text\">asyncio.gather(*tasks)</code>이다.</p>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\"><span class=\"token keyword\">async</span> <span class=\"token keyword\">def</span> <span class=\"token function\">function</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n    tasks <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span>asyncio<span class=\"token punctuation\">.</span>create_task<span class=\"token punctuation\">(</span>_function<span class=\"token punctuation\">(</span>data<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">for</span> data <span class=\"token keyword\">in</span> data_list<span class=\"token punctuation\">]</span> \n    results <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> asyncio<span class=\"token punctuation\">.</span>gather<span class=\"token punctuation\">(</span><span class=\"token operator\">*</span>tasks<span class=\"token punctuation\">)</span>  <span class=\"token comment\"># [result_task_1, result_task_2, ...]</span>\n    <span class=\"token keyword\">return</span> results</code></pre></div>\n<br>\n<h2 id=\"참고\" style=\"position:relative;\"><a href=\"#%EC%B0%B8%EA%B3%A0\" aria-label=\"참고 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>참고</h2>\n<ul>\n<li><a href=\"https://docs.python.org/3/library/asyncio.html\">https://docs.python.org/3/library/asyncio.html</a></li>\n<li><a href=\"https://it-eldorado.tistory.com/159\">https://it-eldorado.tistory.com/159</a></li>\n<li><a href=\"https://soooprmx.com/asyncio/\">https://soooprmx.com/asyncio/</a></li>\n</ul>\n<div class=\"table-of-contents\">\n<ul>\n<li>\n<p><a href=\"#%EB%B9%84%EB%8F%99%EA%B8%B0-%ED%94%84%EB%A1%9C%EA%B7%B8%EB%9E%98%EB%B0%8D%EA%B3%BC-%EB%8F%99%EC%9E%91%EC%9B%90%EB%A6%AC\">비동기 프로그래밍과 동작원리</a></p>\n</li>\n<li>\n<p><a href=\"#coroutine%EC%BD%94%EB%A3%A8%ED%8B%B4\">Coroutine(코루틴)</a></p>\n<ul>\n<li><a href=\"#iterator%EC%9D%B4%ED%84%B0%EB%A0%88%EC%9D%B4%ED%84%B0\">Iterator(이터레이터)</a></li>\n<li><a href=\"#generator%EC%A0%9C%EB%84%88%EB%A0%88%EC%9D%B4%ED%84%B0\">Generator(제너레이터)</a></li>\n</ul>\n</li>\n<li>\n<p><a href=\"#event-loop\">Event Loop</a></p>\n<ul>\n<li><a href=\"#future%ED%93%A8%EC%B3%90%EC%99%80-task%ED%85%8C%EC%8A%A4%ED%81%AC\">Future(퓨쳐)와 Task(테스크)</a></li>\n</ul>\n</li>\n<li>\n<p><a href=\"#event-loop%EA%B0%80-coroutine%EC%9D%84-%EC%8B%A4%ED%96%89%ED%95%98%EB%8A%94-%EB%B0%A9%EC%8B%9D\">Event Loop가 Coroutine을 실행하는 방식</a></p>\n</li>\n<li>\n<p><a href=\"#%EC%B0%B8%EA%B3%A0\">참고</a></p>\n</li>\n</ul>\n</div>","frontmatter":{"date":"May 14, 2023","title":"파이선에서 asyncio로 비동기 처리하기","categories":"python","author":"소희","emoji":"💭"},"fields":{"slug":"/python/asyncio/"}},"site":{"siteMetadata":{"siteUrl":"https://soheeeep.github.io","comments":{"utterances":{"repo":"https://github.com/soheeeeP/soheeeep.github.io"}}}}},"pageContext":{"slug":"/django/migration/","nextSlug":"/github/ci-cd/","prevSlug":"/python/asyncio/"}},
    "staticQueryHashes": ["1073350324","1956554647","2938748437"]}